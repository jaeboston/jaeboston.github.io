<!DOCTYPE html>
<html lang="en">

<head>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66582-32"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-66582-32');
    </script>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Optimization with transaction cost" />
<meta property="og:description" content="Backtest" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jaeboston.github.io/python/quant/optimization_with_tcosts/" />
<meta property="article:published_time" content="2019-04-25T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-04-25T00:00:00&#43;00:00"/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Optimization with transaction cost"/>
<meta name="twitter:description" content="Backtest"/>
<meta name="generator" content="Hugo 0.55.3" /> 
    
    
    
    

    <title>Optimization with transaction cost</title>

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    
    <link href="https://jaeboston.github.io/css/custom.css" rel="stylesheet"> 
    <link href="https://jaeboston.github.io/css/syntax.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">
        
    <link href="" rel="alternate" type="application/rss+xml" title="Tech Knowledge" /> 
    
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>

    <nav class="navbar navbar-expand-sm fixed-top">
        <div class="container">
            <a class="navbar-brand" href="https://jaeboston.github.io/">Technical Notes</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="nav navbar-nav mr-auto"></ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            Notes
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="https://jaeboston.github.io/#python">Python</a>
                            <a class="dropdown-item" href="https://jaeboston.github.io/#statistics">Statistics</a>
                            <a class="dropdown-item" href="https://jaeboston.github.io/#regex">Regular Expressions</a>
                            <a class="dropdown-item" href="https://jaeboston.github.io/#mathematics">Mathematics</a>
                            <a class="dropdown-item" href="https://jaeboston.github.io/#aws">AWS</a>
                            <a class="dropdown-item" href="https://jaeboston.github.io/#computer_science">Computer Science</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://jaeboston.github.io/#articles">Articles</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            About
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="https://jaeboston.github.io/about//">About </a>
                            <a class="dropdown-item" href="https://github.com/jaeboston">GitHub</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    
    <div class="container">
        <div class="row">
            <div class="col-sm-12">

                
<article>
  <div class="page">
    <div class="content">
      

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="err">!</span><span class="p">{</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">}</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">from</span> <span class="nn">statsmodels.formula.api</span> <span class="kn">import</span> <span class="n">ols</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">import</span> <span class="nn">patsy</span>
<span class="kn">from</span> <span class="nn">statistics</span> <span class="kn">import</span> <span class="n">median</span>
<span class="kn">import</span> <span class="nn">datetime</span></code></pre></div>
<h2 id="barra-data">Barra data</h2>

<p>We’ll be using factor data that is generated by Barra.  This will be good practice because Barra data is used throughout the industry.</p>

<p>Note that we&rsquo;ve pre-processed the raw barra data files and stored the data into pickle files. The alternative would be to load the original data, and perform the parsing each time.  Since parsing and pre-processing takes time, we recommend doing the pre-processing once and saving the pre-processed data for later use in your backtest.</p>

<p>Choose the number of years to use for the backtest.  The data is available for years 2003 to 2008 inclusive.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">barra_dir</span> <span class="o">=</span> <span class="s1">&#39;../../data/project_8_barra/&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="err">!</span><span class="n">ls</span> <span class="p">{</span><span class="n">barra_dir</span><span class="p">}</span></code></pre></div>
<pre><code>covariance.2003.pickle  pandas-frames.2003.pickle  price.2003.pickle
covariance.2004.pickle  pandas-frames.2004.pickle  price.2004.pickle
covariance.2005.pickle  pandas-frames.2005.pickle  price.2005.pickle
covariance.2006.pickle  pandas-frames.2006.pickle  price.2006.pickle
covariance.2007.pickle  pandas-frames.2007.pickle  price.2007.pickle
covariance.2008.pickle  pandas-frames.2008.pickle  price.2008.pickle
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2003</span><span class="p">]:</span>
    <span class="n">fil</span> <span class="o">=</span> <span class="n">barra_dir</span> <span class="o">+</span> <span class="s2">&#34;pandas-frames.&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.pickle&#34;</span>
    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span> <span class="n">fil</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span> <span class="p">)</span> <span class="p">))</span>
    
<span class="n">covariance</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2003</span><span class="p">]:</span>
    <span class="n">fil</span> <span class="o">=</span> <span class="n">barra_dir</span> <span class="o">+</span> <span class="s2">&#34;covariance.&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.pickle&#34;</span>
    <span class="n">covariance</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span> <span class="p">)</span> <span class="p">))</span>
    
<span class="n">daily_return</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2003</span><span class="p">,</span> <span class="mi">2004</span><span class="p">]:</span>
    <span class="n">fil</span> <span class="o">=</span> <span class="n">barra_dir</span> <span class="o">+</span> <span class="s2">&#34;price.&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.pickle&#34;</span>
    <span class="n">daily_return</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span> <span class="p">)</span> <span class="p">))</span></code></pre></div>
<h1 id="optimization-with-transaction-costs">Optimization with Transaction costs</h1>

<p>In this lesson, we’ll show you how to incorporate transaction costs into portfolio optimization.  This will give your backtest a more realistic measure of your alpha’s performance.  In addition, we’ll show you some additional ways to design your optimization with efficiency in mind.  This is really helpful when  backtesting, because having reasonably shorter runtimes allows you to test and iterate on your alphas more quickly.</p>

<p>Notice that the frames variale is a dictionary, where the keys are strings representing each business day.</p>

<h2 id="view-the-barra-data">View the Barra data</h2>

<p>We&rsquo;ll take a look at the value stored for a single day (it&rsquo;s a data frame).</p>

<p>As a general reminder of best practices, remember to check what unit of measure your data is in. In some cases, the unit of measure isn’t available in the documentation, so you’ll want to inspect the data to see what makes sense.</p>

<p>For instance, there are volatility fields that are large enough that we can assume they are in percentage units, as opposed to decimal values.  In other cases, when we look at daily volume, we may not have documentation about whether the units are in number of shares or in dollars. One way to find this out is to spot check a single stock on a single day, and cross-reference with another source, such as Bloomberg or Yahoo Finance.
Remember to inspect the data before you use it, as it will help you derive more meaningful results in your portfolio optimization, and in your backtest.</p>

<p>Remember to inspect the data before you use it, as it will help you derive more meaningful results in your portfolio optimization, and in your backtest.</p>

<p>In the exercise, we&rsquo;ll re-scale the data before using it, and there will be comments to point out when we re-scale the data.  So don&rsquo;t worry about adjusting anything here, just take a look to get familiar with the data.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></code></pre></div>
<pre><code>dict_keys(['20030102', '20030103', '20030106', '20030107', '20030108', '20030109', '20030110', '20030113', '20030114', '20030115', '20030116', '20030117', '20030121', '20030122', '20030123', '20030124', '20030127', '20030128', '20030129', '20030130', '20030131', '20030203', '20030204', '20030205', '20030206', '20030207', '20030210', '20030211', '20030212', '20030213', '20030214', '20030218', '20030219', '20030220', '20030221', '20030224', '20030225', '20030226', '20030227', '20030228', '20030303', '20030304', '20030305', '20030306', '20030307', '20030310', '20030311', '20030312', '20030313', '20030314', '20030317', '20030318', '20030319', '20030320', '20030321', '20030324', '20030325', '20030326', '20030327', '20030328', '20030331', '20030401', '20030402', '20030403', '20030404', '20030407', '20030408', '20030409', '20030410', '20030411', '20030414', '20030415', '20030416', '20030417', '20030421', '20030422', '20030423', '20030424', '20030425', '20030428', '20030429', '20030430', '20030501', '20030502', '20030505', '20030506', '20030507', '20030508', '20030509', '20030512', '20030513', '20030514', '20030515', '20030516', '20030519', '20030520', '20030521', '20030522', '20030523', '20030527', '20030528', '20030529', '20030530', '20030602', '20030603', '20030604', '20030605', '20030606', '20030609', '20030610', '20030611', '20030612', '20030613', '20030616', '20030617', '20030618', '20030619', '20030620', '20030623', '20030624', '20030625', '20030626', '20030627', '20030630', '20030701', '20030702', '20030703', '20030707', '20030708', '20030709', '20030710', '20030711', '20030714', '20030715', '20030716', '20030717', '20030718', '20030721', '20030722', '20030723', '20030724', '20030725', '20030728', '20030729', '20030730', '20030731', '20030801', '20030804', '20030805', '20030806', '20030807', '20030808', '20030811', '20030812', '20030813', '20030814', '20030815', '20030818', '20030819', '20030820', '20030821', '20030822', '20030825', '20030826', '20030827', '20030828', '20030829', '20030902', '20030903', '20030904', '20030905', '20030908', '20030909', '20030910', '20030911', '20030912', '20030915', '20030916', '20030917', '20030918', '20030919', '20030922', '20030923', '20030924', '20030925', '20030926', '20030929', '20030930', '20031001', '20031002', '20031003', '20031006', '20031007', '20031008', '20031009', '20031010', '20031013', '20031014', '20031015', '20031016', '20031017', '20031020', '20031021', '20031022', '20031023', '20031024', '20031027', '20031028', '20031029', '20031030', '20031031', '20031103', '20031104', '20031105', '20031106', '20031107', '20031110', '20031111', '20031112', '20031113', '20031114', '20031117', '20031118', '20031119', '20031120', '20031121', '20031124', '20031125', '20031126', '20031128', '20031201', '20031202', '20031203', '20031204', '20031205', '20031208', '20031209', '20031210', '20031211', '20031212', '20031215', '20031216', '20031217', '20031218', '20031219', '20031222', '20031223', '20031224', '20031226', '20031229', '20031230', '20031231'])
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Barrid</th>
      <th>USFASTD_1DREVRSL</th>
      <th>USFASTD_AERODEF</th>
      <th>USFASTD_AIRLINES</th>
      <th>USFASTD_ALUMSTEL</th>
      <th>USFASTD_APPAREL</th>
      <th>USFASTD_AUTO</th>
      <th>USFASTD_BANKS</th>
      <th>USFASTD_BETA</th>
      <th>USFASTD_BEVTOB</th>
      <th>...</th>
      <th>BidAskSpread</th>
      <th>DailyVolume</th>
      <th>ADTCA_30</th>
      <th>IssuerMarketCap</th>
      <th>Yield</th>
      <th>TotalRisk</th>
      <th>SpecRisk</th>
      <th>HistBeta</th>
      <th>PredBeta</th>
      <th>DataDate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>USA0001</td>
      <td>-0.837</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.329</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3.441677e+10</td>
      <td>0.292740</td>
      <td>22.940188</td>
      <td>16.825603</td>
      <td>-0.000285</td>
      <td>0.194528</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>1</th>
      <td>USA0011</td>
      <td>-0.530</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.329</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.758417e+09</td>
      <td>0.000000</td>
      <td>35.056218</td>
      <td>26.040331</td>
      <td>0.000025</td>
      <td>0.150303</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>2</th>
      <td>USA0031</td>
      <td>0.109</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.018</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>2900.0</td>
      <td>NaN</td>
      <td>6.256875e+10</td>
      <td>2.350000</td>
      <td>25.585521</td>
      <td>18.842191</td>
      <td>0.133644</td>
      <td>0.364634</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>3</th>
      <td>USA0062</td>
      <td>-0.259</td>
      <td>0.434</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.378</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.046586e+10</td>
      <td>3.125000</td>
      <td>34.361884</td>
      <td>30.552489</td>
      <td>-0.021132</td>
      <td>0.274658</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>4</th>
      <td>USA0071</td>
      <td>-0.394</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.665</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.332</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.988087e+10</td>
      <td>2.633889</td>
      <td>22.893482</td>
      <td>15.466688</td>
      <td>-0.001328</td>
      <td>0.246267</td>
      <td>20030102</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 92 columns</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<pre><code>(12252, 92)
</code></pre>

<h4 id="factors">Factors</h4>

<p>Note that the data fields that start with the prefix U-S-F-A-S-T are factor exposures, one column for each factor.  We will use some of these as alpha factors, and the rest as risk factors.  The reason this makes sense is that, for the time periods in which we’re back-testing, some of these factors were able to produce better than average returns.  Barra works with its clients (funds) and gathers information about alphas that worked in the past.  These were calculated on historical data to produce the factor exposure data found in the Barra data.</p>

<p><img src="barra_field_factor_exposure.png" alt="alt text" /></p>

<h2 id="factors-1">Factors</h2>

<p>Here&rsquo;s a partial list of the barra factors in our dataset and their definitions.  These are collected from documentation by Barra.  There are style factors and industry factors.  The industry factors will be used as risk factors.  You can consider using the style factors as alpha factors.  Any factors not used as alpha factors can be included in the risk factors category.</p>

<h4 id="style-factors">Style factors</h4>

<ul>
<li>beta: Describes market risk that cannot be explained by the Country factor. The Beta factor is typically the most important style factor. We calculate Beta by time-series regression of stock excess returns against the market return.</li>
<li>1 day reversal</li>
<li>dividend yield: Describes differences in stock returns attributable to stock&rsquo;s historical and predicted dividend-to-price ratios.</li>
<li>downside risk (maximum drawdown)</li>
<li>earnings quality:  Describes stock return differences due to the accrual components of earnings.</li>
<li>earnings yield: Describes return differences based on a company’s earnings relative to its price. Earnings Yield is considered by many investors to be a strong value signal. The most important descriptor in this factor is the analyst-predicted 12-month earnings-to-price ratio.</li>
<li>growth: Differentiates stocks based on their prospects for sales or earnings growth. The most important descriptor in this factor is the analyst predicted long-term earnings growth. Other descriptors include sales and earnings growth over the previous five years.</li>
<li>leverage: Describes return differences between high and low-leverage stocks. The descriptors within this style factor include market leverage, book leverage, and debt-to-assets ratio.</li>
<li>liquidity: Describes return differences due to relative trading activity. The descriptors for this factor are based on the fraction of total shares outstanding that trade over a recent window.</li>
<li>long-term reversal: Describes common variation in returns related to a long-term (five years ex. recent thirteen months) stock price behavior.</li>
<li>management quality</li>
<li>Mid capitalization: Describes non-linearity in the payoff to the Size factor across the market-cap spectrum. This factor is based on a single raw descriptor: the cube of the Size exposure. However, because this raw descriptor is highly collinear with the Size factor, it is orthogonalized with respect to Size. This procedure does not affect the fit of the model, but does mitigate the confounding effects of collinearity, while preserving an intuitive meaning for the Size factor. As described by Menchero (2010), the Mid Capitalization factor roughly captures the risk of a “barbell portfolio” that is long mid-cap stocks and short small-cap and large-cap stocks.</li>
<li>Momentum – Differentiates stocks based on their performance over the trailing 12 months. When computing Momentum exposures, we exclude the most recent returns in order to avoid the effects of short-term reversal. The Momentum factor is often the second strongest factor in the model, although sometimes it may surpass Beta in importance.</li>
<li>Profitability – Combines profitability measures that characterize efficiency of a firm&rsquo;s operations and total activities.</li>
<li>Residual Volatility – Measures the idiosyncratic volatility anomaly. It has three descriptors: (a) the volatility of daily excess returns, (b) the volatility of daily residual returns, and &copy; the cumulative range of the stock over the last 12 months. Since these descriptors tend to be highly collinear with the Beta factor, the Residual Volatility factor is orthogonalized with respect to the Beta and Size factors.</li>
<li>seasonality</li>
<li>sentiment</li>
<li>Size – Represents a strong source of equity return covariance, and captures return differences between large-cap and small-cap stocks. We measure Size by the log of market capitalization.</li>
<li>Short term reversal</li>
<li>Value</li>
<li>Prospect &ndash; is a function of skewness and maximum drawdown.</li>
<li>Management Quality &ndash; is a function of the following:

<ul>
<li>Asset Growth: Annual reported company assets are regressed against time over the past five fiscal years. The slope coefficient is then divided by the average annual assets to obtain the asset growth.</li>
<li>Issuance Growth Annual reported company number of shares outstanding regressed against time over the past five fiscal years. The slope coefficient is then divided by the average annual number of shares outstanding.</li>
<li>Capital Expenditure Growth: Annual reported company capital expenditures are regressed against time over the past five fiscal years. The slope coefficient is then divided by the average annual capital expenditures to obtain the capital expenditures growth.</li>
<li>Capital Expenditure: The most recent capital expenditures are scaled by the average of capital expenditures over the last five fiscal years.</li>
</ul></li>
</ul>

<h4 id="industry-factors">Industry Factors</h4>

<ul>
<li>aerospace and defense</li>
<li>airlines</li>
<li>aluminum and steel</li>
<li>apparel</li>
<li>Automotive</li>
<li>banks</li>
<li>beta (market)</li>
<li>beverage and tobacco</li>
<li>biotech &amp; life science</li>
<li>building products</li>
<li>chemicals</li>
<li>construction &amp; engineering</li>
<li>construction &amp; machinery</li>
<li>construction materials</li>
<li>commercial equipment</li>
<li>computer &amp; electronics</li>
<li>commercial services</li>
<li>industrial conglomerates</li>
<li>containers (forest, paper, &amp; packaging)</li>
<li>distributors</li>
<li>diversified financials</li>
<li>electrical equipment</li>
<li>electrical utility</li>
<li>food &amp; household products &amp; personal</li>
<li>food &amp; staples retailing</li>
<li>gas &amp; multi-utilities</li>
<li>healthcare equipment and services</li>
<li>health services</li>
<li>home building</li>
<li>household durables</li>
<li>industry machinery</li>
<li>non-life insurance</li>
<li>leisure products</li>
<li>leisure services</li>
<li>life insurance</li>
<li>managed healthcare</li>
<li>multi-utilities</li>
<li>oil &amp; gas conversion</li>
<li>oil &amp; gas drilling</li>
<li>oil &amp; gas equipment</li>
<li>oil and gas export</li>
<li>paper</li>
<li>pharmaceuticals</li>
<li>precious metals</li>
<li>personal products</li>
<li>real estate</li>
<li>restaurants</li>
<li>road &amp; rail</li>
<li>semiconductors</li>
<li>semiconductors equipment</li>
<li>software</li>
<li>telecommunications</li>
<li>transportation</li>
<li>wireless</li>
<li>SPTY* and SPLTY* are various industries</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span></code></pre></div>
<pre><code>Index(['Barrid', 'USFASTD_1DREVRSL', 'USFASTD_AERODEF', 'USFASTD_AIRLINES',
       'USFASTD_ALUMSTEL', 'USFASTD_APPAREL', 'USFASTD_AUTO', 'USFASTD_BANKS',
       'USFASTD_BETA', 'USFASTD_BEVTOB', 'USFASTD_BIOLIFE', 'USFASTD_BLDGPROD',
       'USFASTD_CHEM', 'USFASTD_CNSTENG', 'USFASTD_CNSTMACH',
       'USFASTD_CNSTMATL', 'USFASTD_COMMEQP', 'USFASTD_COMPELEC',
       'USFASTD_COMSVCS', 'USFASTD_CONGLOM', 'USFASTD_CONTAINR',
       'USFASTD_DISTRIB', 'USFASTD_DIVFIN', 'USFASTD_DIVYILD',
       'USFASTD_DWNRISK', 'USFASTD_EARNQLTY', 'USFASTD_EARNYILD',
       'USFASTD_ELECEQP', 'USFASTD_ELECUTIL', 'USFASTD_FOODPROD',
       'USFASTD_FOODRET', 'USFASTD_GASUTIL', 'USFASTD_GROWTH',
       'USFASTD_HLTHEQP', 'USFASTD_HLTHSVCS', 'USFASTD_HOMEBLDG',
       'USFASTD_HOUSEDUR', 'USFASTD_INDMACH', 'USFASTD_INDMOM',
       'USFASTD_INSURNCE', 'USFASTD_INTERNET', 'USFASTD_LEISPROD',
       'USFASTD_LEISSVCS', 'USFASTD_LEVERAGE', 'USFASTD_LIFEINS',
       'USFASTD_LIQUIDTY', 'USFASTD_LTREVRSL', 'USFASTD_MEDIA',
       'USFASTD_MGDHLTH', 'USFASTD_MGMTQLTY', 'USFASTD_MIDCAP',
       'USFASTD_MOMENTUM', 'USFASTD_MULTUTIL', 'USFASTD_OILGSCON',
       'USFASTD_OILGSDRL', 'USFASTD_OILGSEQP', 'USFASTD_OILGSEXP',
       'USFASTD_PAPER', 'USFASTD_PHARMA', 'USFASTD_PRECMTLS', 'USFASTD_PROFIT',
       'USFASTD_PROSPECT', 'USFASTD_PSNLPROD', 'USFASTD_REALEST',
       'USFASTD_RESTAUR', 'USFASTD_RESVOL', 'USFASTD_ROADRAIL',
       'USFASTD_SEASON', 'USFASTD_SEMICOND', 'USFASTD_SEMIEQP',
       'USFASTD_SENTMT', 'USFASTD_SIZE', 'USFASTD_SOFTWARE',
       'USFASTD_SPLTYRET', 'USFASTD_SPTYCHEM', 'USFASTD_SPTYSTOR',
       'USFASTD_STREVRSL', 'USFASTD_TELECOM', 'USFASTD_TRADECO',
       'USFASTD_TRANSPRT', 'USFASTD_VALUE', 'USFASTD_WIRELESS', 'BidAskSpread',
       'DailyVolume', 'ADTCA_30', 'IssuerMarketCap', 'Yield', 'TotalRisk',
       'SpecRisk', 'HistBeta', 'PredBeta', 'DataDate'],
      dtype='object')
</code></pre>

<h2 id="covariance-of-factors">covariance of factors</h2>

<p>Let&rsquo;s look at the covariance of the factors.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">covariance</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></code></pre></div>
<pre><code>dict_keys(['20030102', '20030103', '20030106', '20030107', '20030108', '20030109', '20030110', '20030113', '20030114', '20030115', '20030116', '20030117', '20030121', '20030122', '20030123', '20030124', '20030127', '20030128', '20030129', '20030130', '20030131', '20030203', '20030204', '20030205', '20030206', '20030207', '20030210', '20030211', '20030212', '20030213', '20030214', '20030218', '20030219', '20030220', '20030221', '20030224', '20030225', '20030226', '20030227', '20030228', '20030303', '20030304', '20030305', '20030306', '20030307', '20030310', '20030311', '20030312', '20030313', '20030314', '20030317', '20030318', '20030319', '20030320', '20030321', '20030324', '20030325', '20030326', '20030327', '20030328', '20030331', '20030401', '20030402', '20030403', '20030404', '20030407', '20030408', '20030409', '20030410', '20030411', '20030414', '20030415', '20030416', '20030417', '20030421', '20030422', '20030423', '20030424', '20030425', '20030428', '20030429', '20030430', '20030501', '20030502', '20030505', '20030506', '20030507', '20030508', '20030509', '20030512', '20030513', '20030514', '20030515', '20030516', '20030519', '20030520', '20030521', '20030522', '20030523', '20030527', '20030528', '20030529', '20030530', '20030602', '20030603', '20030604', '20030605', '20030606', '20030609', '20030610', '20030611', '20030612', '20030613', '20030616', '20030617', '20030618', '20030619', '20030620', '20030623', '20030624', '20030625', '20030626', '20030627', '20030630', '20030701', '20030702', '20030703', '20030707', '20030708', '20030709', '20030710', '20030711', '20030714', '20030715', '20030716', '20030717', '20030718', '20030721', '20030722', '20030723', '20030724', '20030725', '20030728', '20030729', '20030730', '20030731', '20030801', '20030804', '20030805', '20030806', '20030807', '20030808', '20030811', '20030812', '20030813', '20030814', '20030815', '20030818', '20030819', '20030820', '20030821', '20030822', '20030825', '20030826', '20030827', '20030828', '20030829', '20030902', '20030903', '20030904', '20030905', '20030908', '20030909', '20030910', '20030911', '20030912', '20030915', '20030916', '20030917', '20030918', '20030919', '20030922', '20030923', '20030924', '20030925', '20030926', '20030929', '20030930', '20031001', '20031002', '20031003', '20031006', '20031007', '20031008', '20031009', '20031010', '20031013', '20031014', '20031015', '20031016', '20031017', '20031020', '20031021', '20031022', '20031023', '20031024', '20031027', '20031028', '20031029', '20031030', '20031031', '20031103', '20031104', '20031105', '20031106', '20031107', '20031110', '20031111', '20031112', '20031113', '20031114', '20031117', '20031118', '20031119', '20031120', '20031121', '20031124', '20031125', '20031126', '20031128', '20031201', '20031202', '20031203', '20031204', '20031205', '20031208', '20031209', '20031210', '20031211', '20031212', '20031215', '20031216', '20031217', '20031218', '20031219', '20031222', '20031223', '20031224', '20031226', '20031229', '20031230', '20031231'])
</code></pre>

<p>View the data for a single day.  Notice that the factors are listed in two columns, followed by the covariance between them.  We&rsquo;ll use this data later to create a factor covariance matrix.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">covariance</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Factor1</th>
      <th>Factor2</th>
      <th>VarCovar</th>
      <th>DataDate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>USFASTD_1DREVRSL</td>
      <td>USFASTD_1DREVRSL</td>
      <td>3.665058</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>1</th>
      <td>USFASTD_1DREVRSL</td>
      <td>USFASTD_BETA</td>
      <td>4.042588</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>2</th>
      <td>USFASTD_1DREVRSL</td>
      <td>USFASTD_DIVYILD</td>
      <td>-0.061494</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>3</th>
      <td>USFASTD_1DREVRSL</td>
      <td>USFASTD_DWNRISK</td>
      <td>-0.147935</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>4</th>
      <td>USFASTD_1DREVRSL</td>
      <td>USFASTD_EARNQLTY</td>
      <td>0.083602</td>
      <td>20030102</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="daily-returns">Daily returns</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">daily_return</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></code></pre></div>
<pre><code>dict_keys(['20030102', '20030103', '20030106', '20030107', '20030108', '20030109', '20030110', '20030113', '20030114', '20030115', '20030116', '20030117', '20030121', '20030122', '20030123', '20030124', '20030127', '20030128', '20030129', '20030130', '20030131', '20030203', '20030204', '20030205', '20030206', '20030207', '20030210', '20030211', '20030212', '20030213', '20030214', '20030218', '20030219', '20030220', '20030221', '20030224', '20030225', '20030226', '20030227', '20030228', '20030303', '20030304', '20030305', '20030306', '20030307', '20030310', '20030311', '20030312', '20030313', '20030314', '20030317', '20030318', '20030319', '20030320', '20030321', '20030324', '20030325', '20030326', '20030327', '20030328', '20030331', '20030401', '20030402', '20030403', '20030404', '20030407', '20030408', '20030409', '20030410', '20030411', '20030414', '20030415', '20030416', '20030417', '20030421', '20030422', '20030423', '20030424', '20030425', '20030428', '20030429', '20030430', '20030501', '20030502', '20030505', '20030506', '20030507', '20030508', '20030509', '20030512', '20030513', '20030514', '20030515', '20030516', '20030519', '20030520', '20030521', '20030522', '20030523', '20030527', '20030528', '20030529', '20030530', '20030602', '20030603', '20030604', '20030605', '20030606', '20030609', '20030610', '20030611', '20030612', '20030613', '20030616', '20030617', '20030618', '20030619', '20030620', '20030623', '20030624', '20030625', '20030626', '20030627', '20030630', '20030701', '20030702', '20030703', '20030707', '20030708', '20030709', '20030710', '20030711', '20030714', '20030715', '20030716', '20030717', '20030718', '20030721', '20030722', '20030723', '20030724', '20030725', '20030728', '20030729', '20030730', '20030731', '20030801', '20030804', '20030805', '20030806', '20030807', '20030808', '20030811', '20030812', '20030813', '20030814', '20030815', '20030818', '20030819', '20030820', '20030821', '20030822', '20030825', '20030826', '20030827', '20030828', '20030829', '20030902', '20030903', '20030904', '20030905', '20030908', '20030909', '20030910', '20030911', '20030912', '20030915', '20030916', '20030917', '20030918', '20030919', '20030922', '20030923', '20030924', '20030925', '20030926', '20030929', '20030930', '20031001', '20031002', '20031003', '20031006', '20031007', '20031008', '20031009', '20031010', '20031013', '20031014', '20031015', '20031016', '20031017', '20031020', '20031021', '20031022', '20031023', '20031024', '20031027', '20031028', '20031029', '20031030', '20031031', '20031103', '20031104', '20031105', '20031106', '20031107', '20031110', '20031111', '20031112', '20031113', '20031114', '20031117', '20031118', '20031119', '20031120', '20031121', '20031124', '20031125', '20031126', '20031128', '20031201', '20031202', '20031203', '20031204', '20031205', '20031208', '20031209', '20031210', '20031211', '20031212', '20031215', '20031216', '20031217', '20031218', '20031219', '20031222', '20031223', '20031224', '20031226', '20031229', '20031230', '20031231', '20040102', '20040105', '20040106', '20040107', '20040108', '20040109', '20040112', '20040113', '20040114', '20040115', '20040116', '20040120', '20040121', '20040122', '20040123', '20040126', '20040127', '20040128', '20040129', '20040130', '20040202', '20040203', '20040204', '20040205', '20040206', '20040209', '20040210', '20040211', '20040212', '20040213', '20040217', '20040218', '20040219', '20040220', '20040223', '20040224', '20040225', '20040226', '20040227', '20040301', '20040302', '20040303', '20040304', '20040305', '20040308', '20040309', '20040310', '20040311', '20040312', '20040315', '20040316', '20040317', '20040318', '20040319', '20040322', '20040323', '20040324', '20040325', '20040326', '20040329', '20040330', '20040331', '20040401', '20040402', '20040405', '20040406', '20040407', '20040408', '20040412', '20040413', '20040414', '20040415', '20040416', '20040419', '20040420', '20040421', '20040422', '20040423', '20040426', '20040427', '20040428', '20040429', '20040430', '20040503', '20040504', '20040505', '20040506', '20040507', '20040510', '20040511', '20040512', '20040513', '20040514', '20040517', '20040518', '20040519', '20040520', '20040521', '20040524', '20040525', '20040526', '20040527', '20040528', '20040601', '20040602', '20040603', '20040604', '20040607', '20040608', '20040609', '20040610', '20040614', '20040615', '20040616', '20040617', '20040618', '20040621', '20040622', '20040623', '20040624', '20040625', '20040628', '20040629', '20040630', '20040701', '20040702', '20040706', '20040707', '20040708', '20040709', '20040712', '20040713', '20040714', '20040715', '20040716', '20040719', '20040720', '20040721', '20040722', '20040723', '20040726', '20040727', '20040728', '20040729', '20040730', '20040802', '20040803', '20040804', '20040805', '20040806', '20040809', '20040810', '20040811', '20040812', '20040813', '20040816', '20040817', '20040818', '20040819', '20040820', '20040823', '20040824', '20040825', '20040826', '20040827', '20040830', '20040831', '20040901', '20040902', '20040903', '20040907', '20040908', '20040909', '20040910', '20040913', '20040914', '20040915', '20040916', '20040917', '20040920', '20040921', '20040922', '20040923', '20040924', '20040927', '20040928', '20040929', '20040930', '20041001', '20041004', '20041005', '20041006', '20041007', '20041008', '20041011', '20041012', '20041013', '20041014', '20041015', '20041018', '20041019', '20041020', '20041021', '20041022', '20041025', '20041026', '20041027', '20041028', '20041029', '20041101', '20041102', '20041103', '20041104', '20041105', '20041108', '20041109', '20041110', '20041111', '20041112', '20041115', '20041116', '20041117', '20041118', '20041119', '20041122', '20041123', '20041124', '20041126', '20041129', '20041130', '20041201', '20041202', '20041203', '20041206', '20041207', '20041208', '20041209', '20041210', '20041213', '20041214', '20041215', '20041216', '20041217', '20041220', '20041221', '20041222', '20041223', '20041227', '20041228', '20041229', '20041230', '20041231'])
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">daily_return</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Barrid</th>
      <th>DlyReturn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>80</th>
      <td>USA0001</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>81</th>
      <td>USA0011</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>82</th>
      <td>USA0031</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>83</th>
      <td>USA0062</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>84</th>
      <td>USA0071</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="add-date-for-returns">Add date for returns</h2>

<p>We&rsquo;ll be dealing with two different dates; to help us keep track, let&rsquo;s add an additional column in the daily_return dataframes that stores the date of the returns.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp_date</span> <span class="o">=</span> <span class="s1">&#39;20030102&#39;</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">daily_return</span><span class="p">[</span><span class="n">tmp_date</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Barrid</th>
      <th>DlyReturn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>80</th>
      <td>USA0001</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>81</th>
      <td>USA0011</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>82</th>
      <td>USA0031</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>83</th>
      <td>USA0062</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>84</th>
      <td>USA0071</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp_n_rows</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">tmp_n_rows</span><span class="p">)</span></code></pre></div>
<pre><code>12252
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">tmp_date</span><span class="p">]</span><span class="o">*</span><span class="n">tmp_n_rows</span><span class="p">)</span></code></pre></div>
<pre><code>0        20030102
1        20030102
2        20030102
3        20030102
4        20030102
5        20030102
6        20030102
7        20030102
8        20030102
9        20030102
10       20030102
11       20030102
12       20030102
13       20030102
14       20030102
15       20030102
16       20030102
17       20030102
18       20030102
19       20030102
20       20030102
21       20030102
22       20030102
23       20030102
24       20030102
25       20030102
26       20030102
27       20030102
28       20030102
29       20030102
           ...   
12222    20030102
12223    20030102
12224    20030102
12225    20030102
12226    20030102
12227    20030102
12228    20030102
12229    20030102
12230    20030102
12231    20030102
12232    20030102
12233    20030102
12234    20030102
12235    20030102
12236    20030102
12237    20030102
12238    20030102
12239    20030102
12240    20030102
12241    20030102
12242    20030102
12243    20030102
12244    20030102
12245    20030102
12246    20030102
12247    20030102
12248    20030102
12249    20030102
12250    20030102
12251    20030102
Length: 12252, dtype: object
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;DlyReturnDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">tmp_date</span><span class="p">]</span><span class="o">*</span><span class="n">tmp_n_rows</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Barrid</th>
      <th>DlyReturn</th>
      <th>DlyReturnDate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>80</th>
      <td>USA0001</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>81</th>
      <td>USA0011</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>82</th>
      <td>USA0031</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>83</th>
      <td>USA0062</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>84</th>
      <td>USA0071</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="quiz-add-daily-return-date-to-each-dataframe-in-daily-return-dictionary">Quiz: add daily return date to each dataframe in daily_return dictionary</h2>

<p>Name the column <code>DlyReturnDate</code>.
<strong>Hint</strong>: create a list containing copies of the date, then create a pandas series.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">DlyReturnDate</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">daily_return</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># TODO</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DlyReturnDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">DlyReturnDate</span><span class="p">]</span><span class="o">*</span><span class="n">n_rows</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># check results</span>

<span class="n">daily_return</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Barrid</th>
      <th>DlyReturn</th>
      <th>DlyReturnDate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>80</th>
      <td>USA0001</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>81</th>
      <td>USA0011</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>82</th>
      <td>USA0031</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>83</th>
      <td>USA0062</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>84</th>
      <td>USA0071</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="adjust-dates-to-account-for-trade-execution">Adjust dates to account for trade execution</h2>

<p>The data stored in <code>data</code> and <code>covariance</code> are used to choose the optimal portfolio, whereas the data in <code>daily_return</code> represents the the returns that the optimized portfolio would realize, but only after we&rsquo;ve received the data, then chosen the optimal holdings, and allowed a day to trade into the optimal holdings.  In other words, if we use the data from <code>data</code> and <code>covariance</code> that is collected at the end of Monday, we&rsquo;ll use portfolio optimization to choose the optimal holdings based on this data, perhaps after hours on Monday.  Then on Tuesday, we&rsquo;ll have a day to execute trades to adjust the portfolio into the optimized positions.  Then on Wednesday, we&rsquo;ll realize the returns using those optimal holdings.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Example of what we want</span>
<span class="n">data_date_l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">return_date_l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daily_return</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">len</span><span class="p">(</span><span class="n">data_date_l</span><span class="p">)</span></code></pre></div>
<pre><code>252
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">len</span><span class="p">(</span><span class="n">return_date_l</span><span class="p">)</span></code></pre></div>
<pre><code>504
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">return_date_l_shifted</span> <span class="o">=</span> <span class="n">return_date_l</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">len</span><span class="p">(</span><span class="n">return_date_l_shifted</span><span class="p">)</span></code></pre></div>
<pre><code>252
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># data date</span>
<span class="n">data_date_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></code></pre></div>
<pre><code>'20030102'
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># returns date</span>
<span class="n">return_date_l_shifted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></code></pre></div>
<pre><code>'20030106'
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="n">daily_return</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span></code></pre></div>
<pre><code>Index(['Barrid', 'DlyReturn', 'DlyReturnDate'], dtype='object')
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">daily_return</span><span class="p">[</span><span class="s1">&#39;20030102&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&#34;Barrid&#34;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<pre><code>(12252, 94)
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Barrid</th>
      <th>USFASTD_1DREVRSL</th>
      <th>USFASTD_AERODEF</th>
      <th>USFASTD_AIRLINES</th>
      <th>USFASTD_ALUMSTEL</th>
      <th>USFASTD_APPAREL</th>
      <th>USFASTD_AUTO</th>
      <th>USFASTD_BANKS</th>
      <th>USFASTD_BETA</th>
      <th>USFASTD_BEVTOB</th>
      <th>...</th>
      <th>ADTCA_30</th>
      <th>IssuerMarketCap</th>
      <th>Yield</th>
      <th>TotalRisk</th>
      <th>SpecRisk</th>
      <th>HistBeta</th>
      <th>PredBeta</th>
      <th>DataDate</th>
      <th>DlyReturn</th>
      <th>DlyReturnDate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>USA0001</td>
      <td>-0.837</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.329</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>3.441677e+10</td>
      <td>0.292740</td>
      <td>22.940188</td>
      <td>16.825603</td>
      <td>-0.000285</td>
      <td>0.194528</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>1</th>
      <td>USA0011</td>
      <td>-0.530</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.329</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>1.758417e+09</td>
      <td>0.000000</td>
      <td>35.056218</td>
      <td>26.040331</td>
      <td>0.000025</td>
      <td>0.150303</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>2</th>
      <td>USA0031</td>
      <td>0.109</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.018</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>6.256875e+10</td>
      <td>2.350000</td>
      <td>25.585521</td>
      <td>18.842191</td>
      <td>0.133644</td>
      <td>0.364634</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>3</th>
      <td>USA0062</td>
      <td>-0.259</td>
      <td>0.434</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.378</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>2.046586e+10</td>
      <td>3.125000</td>
      <td>34.361884</td>
      <td>30.552489</td>
      <td>-0.021132</td>
      <td>0.274658</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
    <tr>
      <th>4</th>
      <td>USA0071</td>
      <td>-0.394</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.665</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.332</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>1.988087e+10</td>
      <td>2.633889</td>
      <td>22.893482</td>
      <td>15.466688</td>
      <td>-0.001328</td>
      <td>0.246267</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030102</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 94 columns</p>
</div>

<h2 id="merge-data-and-daily-returns-into-single-dataframe">Merge data and daily returns into single dataframe</h2>

<p>Use a loop to merge the <code>data</code> and <code>daily_return</code> tables on the <code>barrid</code> column.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">frames</span> <span class="o">=</span><span class="p">{}</span>
<span class="c1"># TODO</span>
<span class="n">dlyreturn_n_days_delay</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># TODO</span>
<span class="n">date_shifts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="n">daily_return</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">dlyreturn_n_days_delay</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">+</span><span class="n">dlyreturn_n_days_delay</span><span class="p">])</span>

<span class="c1"># TODO</span>
<span class="k">for</span> <span class="n">data_date</span><span class="p">,</span> <span class="n">price_date</span> <span class="ow">in</span> <span class="n">date_shifts</span><span class="p">:</span>
    <span class="n">frames</span><span class="p">[</span><span class="n">price_date</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data_date</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">daily_return</span><span class="p">[</span><span class="n">price_date</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&#34;Barrid&#34;</span><span class="p">)</span></code></pre></div>
<h2 id="let-s-work-with-a-single-day-s-data-later-we-ll-put-this-into-a-loop">Let&rsquo;s work with a single day&rsquo;s data. Later, we&rsquo;ll put this into a loop</h2>

<p>Notice how the keys are now dates of the returns.  So the earliest date in &ldquo;frames&rdquo; dictionary is two business days after the earliest date in &ldquo;data&rdquo; dictionary.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">frames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></code></pre></div>
<pre><code>dict_keys(['20030106', '20030107', '20030108', '20030109', '20030110', '20030113', '20030114', '20030115', '20030116', '20030117', '20030121', '20030122', '20030123', '20030124', '20030127', '20030128', '20030129', '20030130', '20030131', '20030203', '20030204', '20030205', '20030206', '20030207', '20030210', '20030211', '20030212', '20030213', '20030214', '20030218', '20030219', '20030220', '20030221', '20030224', '20030225', '20030226', '20030227', '20030228', '20030303', '20030304', '20030305', '20030306', '20030307', '20030310', '20030311', '20030312', '20030313', '20030314', '20030317', '20030318', '20030319', '20030320', '20030321', '20030324', '20030325', '20030326', '20030327', '20030328', '20030331', '20030401', '20030402', '20030403', '20030404', '20030407', '20030408', '20030409', '20030410', '20030411', '20030414', '20030415', '20030416', '20030417', '20030421', '20030422', '20030423', '20030424', '20030425', '20030428', '20030429', '20030430', '20030501', '20030502', '20030505', '20030506', '20030507', '20030508', '20030509', '20030512', '20030513', '20030514', '20030515', '20030516', '20030519', '20030520', '20030521', '20030522', '20030523', '20030527', '20030528', '20030529', '20030530', '20030602', '20030603', '20030604', '20030605', '20030606', '20030609', '20030610', '20030611', '20030612', '20030613', '20030616', '20030617', '20030618', '20030619', '20030620', '20030623', '20030624', '20030625', '20030626', '20030627', '20030630', '20030701', '20030702', '20030703', '20030707', '20030708', '20030709', '20030710', '20030711', '20030714', '20030715', '20030716', '20030717', '20030718', '20030721', '20030722', '20030723', '20030724', '20030725', '20030728', '20030729', '20030730', '20030731', '20030801', '20030804', '20030805', '20030806', '20030807', '20030808', '20030811', '20030812', '20030813', '20030814', '20030815', '20030818', '20030819', '20030820', '20030821', '20030822', '20030825', '20030826', '20030827', '20030828', '20030829', '20030902', '20030903', '20030904', '20030905', '20030908', '20030909', '20030910', '20030911', '20030912', '20030915', '20030916', '20030917', '20030918', '20030919', '20030922', '20030923', '20030924', '20030925', '20030926', '20030929', '20030930', '20031001', '20031002', '20031003', '20031006', '20031007', '20031008', '20031009', '20031010', '20031013', '20031014', '20031015', '20031016', '20031017', '20031020', '20031021', '20031022', '20031023', '20031024', '20031027', '20031028', '20031029', '20031030', '20031031', '20031103', '20031104', '20031105', '20031106', '20031107', '20031110', '20031111', '20031112', '20031113', '20031114', '20031117', '20031118', '20031119', '20031120', '20031121', '20031124', '20031125', '20031126', '20031128', '20031201', '20031202', '20031203', '20031204', '20031205', '20031208', '20031209', '20031210', '20031211', '20031212', '20031215', '20031216', '20031217', '20031218', '20031219', '20031222', '20031223', '20031224', '20031226', '20031229', '20031230', '20031231', '20040102', '20040105'])
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="s1">&#39;20030106&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Barrid</th>
      <th>USFASTD_1DREVRSL</th>
      <th>USFASTD_AERODEF</th>
      <th>USFASTD_AIRLINES</th>
      <th>USFASTD_ALUMSTEL</th>
      <th>USFASTD_APPAREL</th>
      <th>USFASTD_AUTO</th>
      <th>USFASTD_BANKS</th>
      <th>USFASTD_BETA</th>
      <th>USFASTD_BEVTOB</th>
      <th>...</th>
      <th>ADTCA_30</th>
      <th>IssuerMarketCap</th>
      <th>Yield</th>
      <th>TotalRisk</th>
      <th>SpecRisk</th>
      <th>HistBeta</th>
      <th>PredBeta</th>
      <th>DataDate</th>
      <th>DlyReturn</th>
      <th>DlyReturnDate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>USA0001</td>
      <td>-0.837</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.329</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>3.441677e+10</td>
      <td>0.292740</td>
      <td>22.940188</td>
      <td>16.825603</td>
      <td>-0.000285</td>
      <td>0.194528</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
    <tr>
      <th>1</th>
      <td>USA0011</td>
      <td>-0.530</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.329</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>1.758417e+09</td>
      <td>0.000000</td>
      <td>35.056218</td>
      <td>26.040331</td>
      <td>0.000025</td>
      <td>0.150303</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
    <tr>
      <th>2</th>
      <td>USA0031</td>
      <td>0.109</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.018</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>6.256875e+10</td>
      <td>2.350000</td>
      <td>25.585521</td>
      <td>18.842191</td>
      <td>0.133644</td>
      <td>0.364634</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
    <tr>
      <th>3</th>
      <td>USA0062</td>
      <td>-0.259</td>
      <td>0.434</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.378</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>2.046586e+10</td>
      <td>3.125000</td>
      <td>34.361884</td>
      <td>30.552489</td>
      <td>-0.021132</td>
      <td>0.274658</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
    <tr>
      <th>4</th>
      <td>USA0071</td>
      <td>-0.394</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.665</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.332</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>1.988087e+10</td>
      <td>2.633889</td>
      <td>22.893482</td>
      <td>15.466688</td>
      <td>-0.001328</td>
      <td>0.246267</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 94 columns</p>
</div>

<h2 id="quiz">Quiz</h2>

<p>Filter the stocks so that the estimation universe has stocks with at least 1 billion in market cap.  As an aside, it doesn&rsquo;t make much of a difference whether we choose a &ldquo;&gt;&rdquo; or &ldquo;&gt;=&rdquo;, since the threshold we choose is just meant to get a set of relatively liquid assets.</p>

<p><strong>Hint</strong>: use <code>.copy(deep=True)</code> to make an independent copy of the data.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="n">estu</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">IssuerMarketCap</span><span class="o">&gt;</span><span class="mf">1e9</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">estu</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Barrid</th>
      <th>USFASTD_1DREVRSL</th>
      <th>USFASTD_AERODEF</th>
      <th>USFASTD_AIRLINES</th>
      <th>USFASTD_ALUMSTEL</th>
      <th>USFASTD_APPAREL</th>
      <th>USFASTD_AUTO</th>
      <th>USFASTD_BANKS</th>
      <th>USFASTD_BETA</th>
      <th>USFASTD_BEVTOB</th>
      <th>...</th>
      <th>ADTCA_30</th>
      <th>IssuerMarketCap</th>
      <th>Yield</th>
      <th>TotalRisk</th>
      <th>SpecRisk</th>
      <th>HistBeta</th>
      <th>PredBeta</th>
      <th>DataDate</th>
      <th>DlyReturn</th>
      <th>DlyReturnDate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>USA0001</td>
      <td>-0.837</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.329</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>3.441677e+10</td>
      <td>0.292740</td>
      <td>22.940188</td>
      <td>16.825603</td>
      <td>-0.000285</td>
      <td>0.194528</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
    <tr>
      <th>1</th>
      <td>USA0011</td>
      <td>-0.530</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.329</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>1.758417e+09</td>
      <td>0.000000</td>
      <td>35.056218</td>
      <td>26.040331</td>
      <td>0.000025</td>
      <td>0.150303</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
    <tr>
      <th>2</th>
      <td>USA0031</td>
      <td>0.109</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.018</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>6.256875e+10</td>
      <td>2.350000</td>
      <td>25.585521</td>
      <td>18.842191</td>
      <td>0.133644</td>
      <td>0.364634</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
    <tr>
      <th>3</th>
      <td>USA0062</td>
      <td>-0.259</td>
      <td>0.434</td>
      <td>0.0</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.378</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>2.046586e+10</td>
      <td>3.125000</td>
      <td>34.361884</td>
      <td>30.552489</td>
      <td>-0.021132</td>
      <td>0.274658</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
    <tr>
      <th>4</th>
      <td>USA0071</td>
      <td>-0.394</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.665</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.332</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>1.988087e+10</td>
      <td>2.633889</td>
      <td>22.893482</td>
      <td>15.466688</td>
      <td>-0.001328</td>
      <td>0.246267</td>
      <td>20030102</td>
      <td>0.0</td>
      <td>20030106</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 94 columns</p>
</div>

<p>For all the columns in the dataframe, the ones with the prefix &ldquo;USFAST&rdquo; are factors.  We&rsquo;ll use a helper function to get the list of factors.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">factors_from_names</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&#34;USFASTD_&#34;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)))</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">all_factors</span> <span class="o">=</span> <span class="n">factors_from_names</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">all_factors</span></code></pre></div>
<pre><code>['USFASTD_1DREVRSL',
 'USFASTD_AERODEF',
 'USFASTD_AIRLINES',
 'USFASTD_ALUMSTEL',
 'USFASTD_APPAREL',
 'USFASTD_AUTO',
 'USFASTD_BANKS',
 'USFASTD_BETA',
 'USFASTD_BEVTOB',
 'USFASTD_BIOLIFE',
 'USFASTD_BLDGPROD',
 'USFASTD_CHEM',
 'USFASTD_CNSTENG',
 'USFASTD_CNSTMACH',
 'USFASTD_CNSTMATL',
 'USFASTD_COMMEQP',
 'USFASTD_COMPELEC',
 'USFASTD_COMSVCS',
 'USFASTD_CONGLOM',
 'USFASTD_CONTAINR',
 'USFASTD_DISTRIB',
 'USFASTD_DIVFIN',
 'USFASTD_DIVYILD',
 'USFASTD_DWNRISK',
 'USFASTD_EARNQLTY',
 'USFASTD_EARNYILD',
 'USFASTD_ELECEQP',
 'USFASTD_ELECUTIL',
 'USFASTD_FOODPROD',
 'USFASTD_FOODRET',
 'USFASTD_GASUTIL',
 'USFASTD_GROWTH',
 'USFASTD_HLTHEQP',
 'USFASTD_HLTHSVCS',
 'USFASTD_HOMEBLDG',
 'USFASTD_HOUSEDUR',
 'USFASTD_INDMACH',
 'USFASTD_INDMOM',
 'USFASTD_INSURNCE',
 'USFASTD_INTERNET',
 'USFASTD_LEISPROD',
 'USFASTD_LEISSVCS',
 'USFASTD_LEVERAGE',
 'USFASTD_LIFEINS',
 'USFASTD_LIQUIDTY',
 'USFASTD_LTREVRSL',
 'USFASTD_MEDIA',
 'USFASTD_MGDHLTH',
 'USFASTD_MGMTQLTY',
 'USFASTD_MIDCAP',
 'USFASTD_MOMENTUM',
 'USFASTD_MULTUTIL',
 'USFASTD_OILGSCON',
 'USFASTD_OILGSDRL',
 'USFASTD_OILGSEQP',
 'USFASTD_OILGSEXP',
 'USFASTD_PAPER',
 'USFASTD_PHARMA',
 'USFASTD_PRECMTLS',
 'USFASTD_PROFIT',
 'USFASTD_PROSPECT',
 'USFASTD_PSNLPROD',
 'USFASTD_REALEST',
 'USFASTD_RESTAUR',
 'USFASTD_RESVOL',
 'USFASTD_ROADRAIL',
 'USFASTD_SEASON',
 'USFASTD_SEMICOND',
 'USFASTD_SEMIEQP',
 'USFASTD_SENTMT',
 'USFASTD_SIZE',
 'USFASTD_SOFTWARE',
 'USFASTD_SPLTYRET',
 'USFASTD_SPTYCHEM',
 'USFASTD_SPTYSTOR',
 'USFASTD_STREVRSL',
 'USFASTD_TELECOM',
 'USFASTD_TRADECO',
 'USFASTD_TRANSPRT',
 'USFASTD_VALUE',
 'USFASTD_WIRELESS']
</code></pre>

<h2 id="factors-exposures-and-factor-returns">factors exposures and factor returns</h2>

<p>Recall that a factor&rsquo;s factor return times its factor exposure gives the part of a stock&rsquo;s return that is explained by that factor.</p>

<p>The Barra data contains the factor exposure of each factor.  We&rsquo;ll use regression to estimate the factor returns of each factor, on each day.  The observations will be the cross section of stock factor exposures, as well as the stock returns that are realized two trading days later.  Recall from an earlier lesson that this is a cross-sectional regression, because it&rsquo;s a cross section of stocks, for a single time period.</p>

<p>$r<em>{i,t} = \sum</em>{j=1}^{k} (\beta<em>{i,j,t-2} \times f</em>{j,t})$<br />
where $i=1&hellip;N$ (N assets),<br />
and $j=1&hellip;k$ (k factors).</p>

<p>In the regression, the factor exposure, $\beta<em>{i,j,t-2}$ is the independent variable, $r</em>{i,t}$ is the dependent variable, and the factor return $f_{j,t}$ is the coefficient that we&rsquo;ll estimate.</p>

<h2 id="calculating-factor-returns">Calculating factor returns</h2>

<p>We&rsquo;ll estimate the factor returns $f<em>{j,t}$ of our chosen alpha factors, using the daily returns of the stocks $r</em>{i,t}$, where $i=1&hellip;N$ and the factor exposure $\beta_{i,j,t-2}$ of each stock to each factor.</p>

<p>Note that we&rsquo;ll use a universe of stocks where the companies have a market capitalization of at least 1 billion.  The factor returns estimated would be slightly different depending on which stock universe is chosen, but choosing a market cap of 1 billion or more provides a reasonable estimate of what you&rsquo;d expect to be tradable.  The estimated factor returns would be fairly close to what you&rsquo;d find if you used the Russell 3000 index as the stock universe.</p>

<h2 id="formula">formula</h2>

<p>We&rsquo;ll use a helper function that creates a string that defines which are the independent and dependent variables for a model to use.  This string is called a &ldquo;formula.&rdquo;  We&rsquo;ll use this in the regression, and later again when we work with matrices.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_formula</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0&#34;</span><span class="p">]</span>
    <span class="n">L</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Y</span> <span class="o">+</span> <span class="s2">&#34; ~ &#34;</span> <span class="o">+</span> <span class="s2">&#34; + &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">L</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">form</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="n">all_factors</span><span class="p">,</span> <span class="s2">&#34;DlyReturn&#34;</span><span class="p">)</span>    </code></pre></div>
<p>So, the formula is saying <code>DlyReturn</code> is the dependent variable, whereas the <code>USFAST...</code> columns are the independent variables.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">form</span></code></pre></div>
<pre><code>'DlyReturn ~ 0 + USFASTD_1DREVRSL + USFASTD_AERODEF + USFASTD_AIRLINES + USFASTD_ALUMSTEL + USFASTD_APPAREL + USFASTD_AUTO + USFASTD_BANKS + USFASTD_BETA + USFASTD_BEVTOB + USFASTD_BIOLIFE + USFASTD_BLDGPROD + USFASTD_CHEM + USFASTD_CNSTENG + USFASTD_CNSTMACH + USFASTD_CNSTMATL + USFASTD_COMMEQP + USFASTD_COMPELEC + USFASTD_COMSVCS + USFASTD_CONGLOM + USFASTD_CONTAINR + USFASTD_DISTRIB + USFASTD_DIVFIN + USFASTD_DIVYILD + USFASTD_DWNRISK + USFASTD_EARNQLTY + USFASTD_EARNYILD + USFASTD_ELECEQP + USFASTD_ELECUTIL + USFASTD_FOODPROD + USFASTD_FOODRET + USFASTD_GASUTIL + USFASTD_GROWTH + USFASTD_HLTHEQP + USFASTD_HLTHSVCS + USFASTD_HOMEBLDG + USFASTD_HOUSEDUR + USFASTD_INDMACH + USFASTD_INDMOM + USFASTD_INSURNCE + USFASTD_INTERNET + USFASTD_LEISPROD + USFASTD_LEISSVCS + USFASTD_LEVERAGE + USFASTD_LIFEINS + USFASTD_LIQUIDTY + USFASTD_LTREVRSL + USFASTD_MEDIA + USFASTD_MGDHLTH + USFASTD_MGMTQLTY + USFASTD_MIDCAP + USFASTD_MOMENTUM + USFASTD_MULTUTIL + USFASTD_OILGSCON + USFASTD_OILGSDRL + USFASTD_OILGSEQP + USFASTD_OILGSEXP + USFASTD_PAPER + USFASTD_PHARMA + USFASTD_PRECMTLS + USFASTD_PROFIT + USFASTD_PROSPECT + USFASTD_PSNLPROD + USFASTD_REALEST + USFASTD_RESTAUR + USFASTD_RESVOL + USFASTD_ROADRAIL + USFASTD_SEASON + USFASTD_SEMICOND + USFASTD_SEMIEQP + USFASTD_SENTMT + USFASTD_SIZE + USFASTD_SOFTWARE + USFASTD_SPLTYRET + USFASTD_SPTYCHEM + USFASTD_SPTYSTOR + USFASTD_STREVRSL + USFASTD_TELECOM + USFASTD_TRADECO + USFASTD_TRANSPRT + USFASTD_VALUE + USFASTD_WIRELESS'
</code></pre>

<h2 id="quiz-1">Quiz</h2>

<p>Run an ordinary least squares regression</p>

<p><a href="https://www.statsmodels.org/dev/example_formulas.html">ols documentation</a></p>

<p>Here&rsquo;s an example of the syntax.</p>

<pre><code>ols(formula='y ~ x1 + x2 + x3', data=dataframe)
</code></pre>

<p>Note that you&rsquo;re free to choose other regression models, such as ridge, lasso, or elastic net.  These may give you slightly different estimations of factor returns, but shouldn&rsquo;t be too different from each other.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: create the ols model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">estu</span><span class="p">)</span>

<span class="c1"># TODO: fit the model</span>
<span class="n">results</span> <span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span></code></pre></div>
<p>Since the factor data that we&rsquo;re using as the independent variables are the factor exposures, the coefficients estimated by the regression are the estimated factor returns.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">results</span><span class="o">.</span><span class="n">params</span></code></pre></div>
<pre><code>USFASTD_1DREVRSL   -0.001948
USFASTD_AERODEF     0.018175
USFASTD_AIRLINES    0.013188
USFASTD_ALUMSTEL    0.027166
USFASTD_APPAREL     0.005058
USFASTD_AUTO        0.015605
USFASTD_BANKS       0.018626
USFASTD_BETA        0.006976
USFASTD_BEVTOB      0.013862
USFASTD_BIOLIFE     0.008931
USFASTD_BLDGPROD    0.015665
USFASTD_CHEM        0.019634
USFASTD_CNSTENG     0.028528
USFASTD_CNSTMACH    0.020496
USFASTD_CNSTMATL    0.004233
USFASTD_COMMEQP     0.047522
USFASTD_COMPELEC    0.031977
USFASTD_COMSVCS     0.019136
USFASTD_CONGLOM     0.027570
USFASTD_CONTAINR    0.001862
USFASTD_DISTRIB     0.011815
USFASTD_DIVFIN      0.023511
USFASTD_DIVYILD     0.002793
USFASTD_DWNRISK    -0.001370
USFASTD_EARNQLTY    0.000626
USFASTD_EARNYILD    0.000545
USFASTD_ELECEQP     0.008392
USFASTD_ELECUTIL    0.039548
USFASTD_FOODPROD    0.012766
USFASTD_FOODRET     0.014855
                      ...   
USFASTD_MULTUTIL    0.007267
USFASTD_OILGSCON    0.027288
USFASTD_OILGSDRL   -0.016669
USFASTD_OILGSEQP   -0.006362
USFASTD_OILGSEXP    0.013279
USFASTD_PAPER       0.018592
USFASTD_PHARMA      0.021252
USFASTD_PRECMTLS    0.021245
USFASTD_PROFIT     -0.001238
USFASTD_PROSPECT   -0.000946
USFASTD_PSNLPROD    0.027450
USFASTD_REALEST     0.014416
USFASTD_RESTAUR     0.024002
USFASTD_RESVOL     -0.001236
USFASTD_ROADRAIL    0.016449
USFASTD_SEASON     -0.000681
USFASTD_SEMICOND    0.029540
USFASTD_SEMIEQP     0.039211
USFASTD_SENTMT     -0.000025
USFASTD_SIZE        0.000202
USFASTD_SOFTWARE    0.030222
USFASTD_SPLTYRET    0.022529
USFASTD_SPTYCHEM    0.022147
USFASTD_SPTYSTOR    0.004087
USFASTD_STREVRSL   -0.000578
USFASTD_TELECOM     0.037187
USFASTD_TRADECO     0.013308
USFASTD_TRANSPRT    0.020613
USFASTD_VALUE       0.000354
USFASTD_WIRELESS    0.039940
Length: 81, dtype: float64
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span></code></pre></div>
<p><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>        <td>DlyReturn</td>    <th>  R-squared:         </th> <td>   0.448</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.422</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   16.80</td>
</tr>
<tr>
  <th>Date:</th>             <td>Thu, 25 Apr 2019</td> <th>  Prob (F-statistic):</th> <td>4.87e-162</td>
</tr>
<tr>
  <th>Time:</th>                 <td>18:17:37</td>     <th>  Log-Likelihood:    </th> <td>  4060.8</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>  1756</td>      <th>  AIC:               </th> <td>  -7960.</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>  1675</td>      <th>  BIC:               </th> <td>  -7516.</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>    81</td>      <th>                     </th>     <td> </td><br />
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td><br />
</tr>
</table>
<table class="simpletable">
<tr>
          <td></td>            <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P&gt;|t|</th>  <th>[0.025</th>    <th>0.975]</th><br />
</tr>
<tr>
  <th>USFASTD_1DREVRSL</th> <td>   -0.0019</td> <td>    0.001</td> <td>   -2.553</td> <td> 0.011</td> <td>   -0.003</td> <td>   -0.000</td>
</tr>
<tr>
  <th>USFASTD_AERODEF</th>  <td>    0.0182</td> <td>    0.007</td> <td>    2.663</td> <td> 0.008</td> <td>    0.005</td> <td>    0.032</td>
</tr>
<tr>
  <th>USFASTD_AIRLINES</th> <td>    0.0132</td> <td>    0.008</td> <td>    1.588</td> <td> 0.112</td> <td>   -0.003</td> <td>    0.029</td>
</tr>
<tr>
  <th>USFASTD_ALUMSTEL</th> <td>    0.0272</td> <td>    0.007</td> <td>    3.690</td> <td> 0.000</td> <td>    0.013</td> <td>    0.042</td>
</tr>
<tr>
  <th>USFASTD_APPAREL</th>  <td>    0.0051</td> <td>    0.008</td> <td>    0.622</td> <td> 0.534</td> <td>   -0.011</td> <td>    0.021</td>
</tr>
<tr>
  <th>USFASTD_AUTO</th>     <td>    0.0156</td> <td>    0.006</td> <td>    2.632</td> <td> 0.009</td> <td>    0.004</td> <td>    0.027</td>
</tr>
<tr>
  <th>USFASTD_BANKS</th>    <td>    0.0186</td> <td>    0.003</td> <td>    6.848</td> <td> 0.000</td> <td>    0.013</td> <td>    0.024</td>
</tr>
<tr>
  <th>USFASTD_BETA</th>     <td>    0.0070</td> <td>    0.001</td> <td>    8.915</td> <td> 0.000</td> <td>    0.005</td> <td>    0.009</td>
</tr>
<tr>
  <th>USFASTD_BEVTOB</th>   <td>    0.0139</td> <td>    0.004</td> <td>    3.129</td> <td> 0.002</td> <td>    0.005</td> <td>    0.023</td>
</tr>
<tr>
  <th>USFASTD_BIOLIFE</th>  <td>    0.0089</td> <td>    0.005</td> <td>    1.821</td> <td> 0.069</td> <td>   -0.001</td> <td>    0.019</td>
</tr>
<tr>
  <th>USFASTD_BLDGPROD</th> <td>    0.0157</td> <td>    0.018</td> <td>    0.875</td> <td> 0.381</td> <td>   -0.019</td> <td>    0.051</td>
</tr>
<tr>
  <th>USFASTD_CHEM</th>     <td>    0.0196</td> <td>    0.006</td> <td>    3.324</td> <td> 0.001</td> <td>    0.008</td> <td>    0.031</td>
</tr>
<tr>
  <th>USFASTD_CNSTENG</th>  <td>    0.0285</td> <td>    0.018</td> <td>    1.594</td> <td> 0.111</td> <td>   -0.007</td> <td>    0.064</td>
</tr>
<tr>
  <th>USFASTD_CNSTMACH</th> <td>    0.0205</td> <td>    0.009</td> <td>    2.405</td> <td> 0.016</td> <td>    0.004</td> <td>    0.037</td>
</tr>
<tr>
  <th>USFASTD_CNSTMATL</th> <td>    0.0042</td> <td>    0.008</td> <td>    0.522</td> <td> 0.602</td> <td>   -0.012</td> <td>    0.020</td>
</tr>
<tr>
  <th>USFASTD_COMMEQP</th>  <td>    0.0475</td> <td>    0.005</td> <td>    9.337</td> <td> 0.000</td> <td>    0.038</td> <td>    0.058</td>
</tr>
<tr>
  <th>USFASTD_COMPELEC</th> <td>    0.0320</td> <td>    0.004</td> <td>    8.496</td> <td> 0.000</td> <td>    0.025</td> <td>    0.039</td>
</tr>
<tr>
  <th>USFASTD_COMSVCS</th>  <td>    0.0191</td> <td>    0.003</td> <td>    5.535</td> <td> 0.000</td> <td>    0.012</td> <td>    0.026</td>
</tr>
<tr>
  <th>USFASTD_CONGLOM</th>  <td>    0.0276</td> <td>    0.010</td> <td>    2.840</td> <td> 0.005</td> <td>    0.009</td> <td>    0.047</td>
</tr>
<tr>
  <th>USFASTD_CONTAINR</th> <td>    0.0019</td> <td>    0.008</td> <td>    0.220</td> <td> 0.826</td> <td>   -0.015</td> <td>    0.019</td>
</tr>
<tr>
  <th>USFASTD_DISTRIB</th>  <td>    0.0118</td> <td>    0.006</td> <td>    2.012</td> <td> 0.044</td> <td>    0.000</td> <td>    0.023</td>
</tr>
<tr>
  <th>USFASTD_DIVFIN</th>   <td>    0.0235</td> <td>    0.003</td> <td>    6.984</td> <td> 0.000</td> <td>    0.017</td> <td>    0.030</td>
</tr>
<tr>
  <th>USFASTD_DIVYILD</th>  <td>    0.0028</td> <td>    0.001</td> <td>    3.622</td> <td> 0.000</td> <td>    0.001</td> <td>    0.004</td>
</tr>
<tr>
  <th>USFASTD_DWNRISK</th>  <td>   -0.0014</td> <td>    0.001</td> <td>   -2.182</td> <td> 0.029</td> <td>   -0.003</td> <td>   -0.000</td>
</tr>
<tr>
  <th>USFASTD_EARNQLTY</th> <td>    0.0006</td> <td>    0.001</td> <td>    0.772</td> <td> 0.440</td> <td>   -0.001</td> <td>    0.002</td>
</tr>
<tr>
  <th>USFASTD_EARNYILD</th> <td>    0.0005</td> <td>    0.001</td> <td>    0.598</td> <td> 0.550</td> <td>   -0.001</td> <td>    0.002</td>
</tr>
<tr>
  <th>USFASTD_ELECEQP</th>  <td>    0.0084</td> <td>    0.007</td> <td>    1.214</td> <td> 0.225</td> <td>   -0.005</td> <td>    0.022</td>
</tr>
<tr>
  <th>USFASTD_ELECUTIL</th> <td>    0.0395</td> <td>    0.005</td> <td>    8.558</td> <td> 0.000</td> <td>    0.030</td> <td>    0.049</td>
</tr>
<tr>
  <th>USFASTD_FOODPROD</th> <td>    0.0128</td> <td>    0.005</td> <td>    2.677</td> <td> 0.008</td> <td>    0.003</td> <td>    0.022</td>
</tr>
<tr>
  <th>USFASTD_FOODRET</th>  <td>    0.0149</td> <td>    0.006</td> <td>    2.542</td> <td> 0.011</td> <td>    0.003</td> <td>    0.026</td>
</tr>
<tr>
  <th>USFASTD_GASUTIL</th>  <td>    0.0257</td> <td>    0.007</td> <td>    3.600</td> <td> 0.000</td> <td>    0.012</td> <td>    0.040</td>
</tr>
<tr>
  <th>USFASTD_GROWTH</th>   <td>    0.0003</td> <td>    0.001</td> <td>    0.409</td> <td> 0.682</td> <td>   -0.001</td> <td>    0.002</td>
</tr>
<tr>
  <th>USFASTD_HLTHEQP</th>  <td>    0.0161</td> <td>    0.004</td> <td>    3.578</td> <td> 0.000</td> <td>    0.007</td> <td>    0.025</td>
</tr>
<tr>
  <th>USFASTD_HLTHSVCS</th> <td>    0.0260</td> <td>    0.005</td> <td>    5.496</td> <td> 0.000</td> <td>    0.017</td> <td>    0.035</td>
</tr>
<tr>
  <th>USFASTD_HOMEBLDG</th> <td>   -0.0081</td> <td>    0.008</td> <td>   -0.965</td> <td> 0.335</td> <td>   -0.025</td> <td>    0.008</td>
</tr>
<tr>
  <th>USFASTD_HOUSEDUR</th> <td>    0.0309</td> <td>    0.006</td> <td>    5.156</td> <td> 0.000</td> <td>    0.019</td> <td>    0.043</td>
</tr>
<tr>
  <th>USFASTD_INDMACH</th>  <td>    0.0108</td> <td>    0.006</td> <td>    1.814</td> <td> 0.070</td> <td>   -0.001</td> <td>    0.023</td>
</tr>
<tr>
  <th>USFASTD_INDMOM</th>   <td>   -0.0006</td> <td>    0.001</td> <td>   -1.026</td> <td> 0.305</td> <td>   -0.002</td> <td>    0.001</td>
</tr>
<tr>
  <th>USFASTD_INSURNCE</th> <td>    0.0222</td> <td>    0.004</td> <td>    5.236</td> <td> 0.000</td> <td>    0.014</td> <td>    0.031</td>
</tr>
<tr>
  <th>USFASTD_INTERNET</th> <td>    0.0141</td> <td>    0.006</td> <td>    2.530</td> <td> 0.012</td> <td>    0.003</td> <td>    0.025</td>
</tr>
<tr>
  <th>USFASTD_LEISPROD</th> <td>    0.0164</td> <td>    0.006</td> <td>    2.979</td> <td> 0.003</td> <td>    0.006</td> <td>    0.027</td>
</tr>
<tr>
  <th>USFASTD_LEISSVCS</th> <td>   -0.0028</td> <td>    0.005</td> <td>   -0.529</td> <td> 0.597</td> <td>   -0.013</td> <td>    0.008</td>
</tr>
<tr>
  <th>USFASTD_LEVERAGE</th> <td>    0.0011</td> <td>    0.001</td> <td>    1.326</td> <td> 0.185</td> <td>   -0.001</td> <td>    0.003</td>
</tr>
<tr>
  <th>USFASTD_LIFEINS</th>  <td>    0.0106</td> <td>    0.006</td> <td>    1.768</td> <td> 0.077</td> <td>   -0.001</td> <td>    0.022</td>
</tr>
<tr>
  <th>USFASTD_LIQUIDTY</th> <td>    0.0008</td> <td>    0.001</td> <td>    1.520</td> <td> 0.129</td> <td>   -0.000</td> <td>    0.002</td>
</tr>
<tr>
  <th>USFASTD_LTREVRSL</th> <td>   -0.0003</td> <td>    0.001</td> <td>   -0.415</td> <td> 0.678</td> <td>   -0.002</td> <td>    0.001</td>
</tr>
<tr>
  <th>USFASTD_MEDIA</th>    <td>    0.0229</td> <td>    0.003</td> <td>    7.745</td> <td> 0.000</td> <td>    0.017</td> <td>    0.029</td>
</tr>
<tr>
  <th>USFASTD_MGDHLTH</th>  <td>    0.0113</td> <td>    0.007</td> <td>    1.517</td> <td> 0.130</td> <td>   -0.003</td> <td>    0.026</td>
</tr>
<tr>
  <th>USFASTD_MGMTQLTY</th> <td>    0.0010</td> <td>    0.001</td> <td>    1.281</td> <td> 0.200</td> <td>   -0.001</td> <td>    0.002</td>
</tr>
<tr>
  <th>USFASTD_MIDCAP</th>   <td>   -0.0006</td> <td>    0.003</td> <td>   -0.209</td> <td> 0.835</td> <td>   -0.006</td> <td>    0.005</td>
</tr>
<tr>
  <th>USFASTD_MOMENTUM</th> <td>   -0.0023</td> <td>    0.001</td> <td>   -2.681</td> <td> 0.007</td> <td>   -0.004</td> <td>   -0.001</td>
</tr>
<tr>
  <th>USFASTD_MULTUTIL</th> <td>    0.0073</td> <td>    0.008</td> <td>    0.921</td> <td> 0.357</td> <td>   -0.008</td> <td>    0.023</td>
</tr>
<tr>
  <th>USFASTD_OILGSCON</th> <td>    0.0273</td> <td>    0.005</td> <td>    5.183</td> <td> 0.000</td> <td>    0.017</td> <td>    0.038</td>
</tr>
<tr>
  <th>USFASTD_OILGSDRL</th> <td>   -0.0167</td> <td>    0.007</td> <td>   -2.335</td> <td> 0.020</td> <td>   -0.031</td> <td>   -0.003</td>
</tr>
<tr>
  <th>USFASTD_OILGSEQP</th> <td>   -0.0064</td> <td>    0.007</td> <td>   -0.897</td> <td> 0.370</td> <td>   -0.020</td> <td>    0.008</td>
</tr>
<tr>
  <th>USFASTD_OILGSEXP</th> <td>    0.0133</td> <td>    0.005</td> <td>    2.867</td> <td> 0.004</td> <td>    0.004</td> <td>    0.022</td>
</tr>
<tr>
  <th>USFASTD_PAPER</th>    <td>    0.0186</td> <td>    0.007</td> <td>    2.686</td> <td> 0.007</td> <td>    0.005</td> <td>    0.032</td>
</tr>
<tr>
  <th>USFASTD_PHARMA</th>   <td>    0.0213</td> <td>    0.004</td> <td>    5.337</td> <td> 0.000</td> <td>    0.013</td> <td>    0.029</td>
</tr>
<tr>
  <th>USFASTD_PRECMTLS</th> <td>    0.0212</td> <td>    0.005</td> <td>    4.269</td> <td> 0.000</td> <td>    0.011</td> <td>    0.031</td>
</tr>
<tr>
  <th>USFASTD_PROFIT</th>   <td>   -0.0012</td> <td>    0.001</td> <td>   -1.126</td> <td> 0.260</td> <td>   -0.003</td> <td>    0.001</td>
</tr>
<tr>
  <th>USFASTD_PROSPECT</th> <td>   -0.0009</td> <td>    0.001</td> <td>   -1.520</td> <td> 0.129</td> <td>   -0.002</td> <td>    0.000</td>
</tr>
<tr>
  <th>USFASTD_PSNLPROD</th> <td>    0.0275</td> <td>    0.006</td> <td>    4.635</td> <td> 0.000</td> <td>    0.016</td> <td>    0.039</td>
</tr>
<tr>
  <th>USFASTD_REALEST</th>  <td>    0.0144</td> <td>    0.004</td> <td>    3.824</td> <td> 0.000</td> <td>    0.007</td> <td>    0.022</td>
</tr>
<tr>
  <th>USFASTD_RESTAUR</th>  <td>    0.0240</td> <td>    0.007</td> <td>    3.688</td> <td> 0.000</td> <td>    0.011</td> <td>    0.037</td>
</tr>
<tr>
  <th>USFASTD_RESVOL</th>   <td>   -0.0012</td> <td>    0.001</td> <td>   -1.642</td> <td> 0.101</td> <td>   -0.003</td> <td>    0.000</td>
</tr>
<tr>
  <th>USFASTD_ROADRAIL</th> <td>    0.0164</td> <td>    0.007</td> <td>    2.220</td> <td> 0.027</td> <td>    0.002</td> <td>    0.031</td>
</tr>
<tr>
  <th>USFASTD_SEASON</th>   <td>   -0.0007</td> <td>    0.001</td> <td>   -1.003</td> <td> 0.316</td> <td>   -0.002</td> <td>    0.001</td>
</tr>
<tr>
  <th>USFASTD_SEMICOND</th> <td>    0.0295</td> <td>    0.004</td> <td>    6.636</td> <td> 0.000</td> <td>    0.021</td> <td>    0.038</td>
</tr>
<tr>
  <th>USFASTD_SEMIEQP</th>  <td>    0.0392</td> <td>    0.008</td> <td>    5.219</td> <td> 0.000</td> <td>    0.024</td> <td>    0.054</td>
</tr>
<tr>
  <th>USFASTD_SENTMT</th>   <td>-2.504e-05</td> <td>    0.001</td> <td>   -0.031</td> <td> 0.975</td> <td>   -0.002</td> <td>    0.002</td>
</tr>
<tr>
  <th>USFASTD_SIZE</th>     <td>    0.0002</td> <td>    0.002</td> <td>    0.128</td> <td> 0.898</td> <td>   -0.003</td> <td>    0.003</td>
</tr>
<tr>
  <th>USFASTD_SOFTWARE</th> <td>    0.0302</td> <td>    0.004</td> <td>    6.911</td> <td> 0.000</td> <td>    0.022</td> <td>    0.039</td>
</tr>
<tr>
  <th>USFASTD_SPLTYRET</th> <td>    0.0225</td> <td>    0.007</td> <td>    3.061</td> <td> 0.002</td> <td>    0.008</td> <td>    0.037</td>
</tr>
<tr>
  <th>USFASTD_SPTYCHEM</th> <td>    0.0221</td> <td>    0.007</td> <td>    3.018</td> <td> 0.003</td> <td>    0.008</td> <td>    0.037</td>
</tr>
<tr>
  <th>USFASTD_SPTYSTOR</th> <td>    0.0041</td> <td>    0.006</td> <td>    0.701</td> <td> 0.484</td> <td>   -0.007</td> <td>    0.016</td>
</tr>
<tr>
  <th>USFASTD_STREVRSL</th> <td>   -0.0006</td> <td>    0.001</td> <td>   -0.749</td> <td> 0.454</td> <td>   -0.002</td> <td>    0.001</td>
</tr>
<tr>
  <th>USFASTD_TELECOM</th>  <td>    0.0372</td> <td>    0.004</td> <td>    9.174</td> <td> 0.000</td> <td>    0.029</td> <td>    0.045</td>
</tr>
<tr>
  <th>USFASTD_TRADECO</th>  <td>    0.0133</td> <td>    0.009</td> <td>    1.530</td> <td> 0.126</td> <td>   -0.004</td> <td>    0.030</td>
</tr>
<tr>
  <th>USFASTD_TRANSPRT</th> <td>    0.0206</td> <td>    0.008</td> <td>    2.674</td> <td> 0.008</td> <td>    0.005</td> <td>    0.036</td>
</tr>
<tr>
  <th>USFASTD_VALUE</th>    <td>    0.0004</td> <td>    0.001</td> <td>    0.437</td> <td> 0.662</td> <td>   -0.001</td> <td>    0.002</td>
</tr>
<tr>
  <th>USFASTD_WIRELESS</th> <td>    0.0399</td> <td>    0.006</td> <td>    7.029</td> <td> 0.000</td> <td>    0.029</td> <td>    0.051</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>2091.189</td> <th>  Durbin-Watson:     </th>  <td>   2.119</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th>  <td> 0.000</td>  <th>  Jarque-Bera (JB):  </th> <td>834567.726</td>
</tr>
<tr>
  <th>Skew:</th>           <td>-5.619</td>  <th>  Prob(JB):          </th>  <td>    0.00</td>
</tr>
<tr>
  <th>Kurtosis:</th>       <td>109.208</td> <th>  Cond. No.          </th>  <td>    61.3</td>
</tr>
</table><br/><br/>Warnings:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#: EXAMPLE cell</span>

<span class="c1">#: TO understand how the OLS regression works</span>
<span class="c1">#: using very simple example</span>
<span class="c1">#: coef = (X.T*X)^-1*X.T*y</span>
<span class="c1">#: y = coef * X + intercept</span>
<span class="kn">from</span> <span class="nn">patsy</span> <span class="kn">import</span> <span class="n">dmatrices</span><span class="p">,</span> <span class="n">build_design_matrices</span>
<span class="k">def</span> <span class="nf">factors_from_names_T</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&#34;USFASTD_T&#34;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)))</span>



<span class="n">factors_T</span> <span class="o">=</span> <span class="n">factors_from_names_T</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="n">form_T</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="n">factors_T</span><span class="p">,</span> <span class="s2">&#34;DlyReturn&#34;</span><span class="p">)</span>    

<span class="n">testdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">IssuerMarketCap</span><span class="o">&gt;</span><span class="mf">2.5e11</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">testdf</span> <span class="o">=</span> <span class="n">testdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;DlyReturn&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,[</span><span class="s1">&#39;USFASTD_VALUE&#39;</span><span class="p">,</span><span class="s1">&#39;USFASTD_TRANSPRT&#39;</span><span class="p">,</span><span class="s1">&#39;DataDate&#39;</span><span class="p">,</span><span class="s1">&#39;DlyReturn&#39;</span><span class="p">,</span><span class="s1">&#39;DlyReturnDate&#39;</span><span class="p">]]</span>

<span class="c1">#: model with intercept</span>
<span class="c1">#model_T = ols(formula=&#39;DlyReturn ~ USFASTD_VALUE&#39;, data = testdf)</span>

<span class="c1">#: model without intercept</span>
<span class="n">model_T</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s1">&#39;DlyReturn ~ 0 + USFASTD_VALUE&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">testdf</span><span class="p">)</span>
<span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;DlyReturn ~  0+ USFASTD_VALUE&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">testdf</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;dataframe&#39;</span><span class="p">)</span>

<span class="n">results_T</span> <span class="o">=</span><span class="n">model_T</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">testdf</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">results_T</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;===============&#39;</span><span class="p">)</span>
<span class="n">tmp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">values</span> <span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">tmp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">X</span><span class="p">)),</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="n">y</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">tmp1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;===============&#39;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">tmp1</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span></code></pre></div>
<pre><code>      USFASTD_VALUE  USFASTD_TRANSPRT  DataDate  DlyReturn DlyReturnDate
4109         -0.369               0.0  20030102   0.025591      20030106
5000         -0.596               0.0  20030102   0.018219      20030106
USFASTD_VALUE   -0.041316
dtype: float64
===============
[[-0.04131574]]
[[-0.04131574]]
===============
[[0.01524551]
 [0.02462418]]
      DlyReturn
4109   0.025591
5000   0.018219
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"></code></pre></div>
<h2 id="quiz-winsorize-daily-returns-before-calculating-factor-returns">Quiz: winsorize daily returns before calculating factor returns</h2>

<p>We&rsquo;re going to use regression to estimate the factor returns of all the factors.  To avoid using extreme values in the regression, we&rsquo;ll winsorize, or &ldquo;clip&rdquo; the returns.  We can check the data distribution using a density plot.</p>

<p>Note that <a href="https://docs.scipy.org/doc/numpy-1.13.0/reference/generated/numpy.where.html">numpy.where</a> has the form</p>

<pre><code>numpy.where(&lt;condition&gt;, &lt;value if true&gt;, &lt;value if false&gt;)
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">wins</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">wins_lower</span><span class="p">,</span><span class="n">wins_upper</span><span class="p">):</span>
    <span class="c1">#TODO</span>
    <span class="n">clipped_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">wins_upper</span><span class="p">,</span> <span class="n">wins_upper</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="n">clipped_both</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clipped_upper</span> <span class="o">&lt;=</span> <span class="n">wins_lower</span><span class="p">,</span> <span class="n">wins_lower</span><span class="p">,</span><span class="n">clipped_upper</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clipped_both</span></code></pre></div>
<p>A density plot will help us visually check the effect of winsorizing returns.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">density_plot</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> 
    <span class="n">density</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">density</span><span class="o">.</span><span class="n">covariance_factor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="o">.</span><span class="mi">25</span>
    <span class="n">density</span><span class="o">.</span><span class="n">_compute_covariance</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="n">density</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># distribution without winsorizing</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="s1">&#39;20040102&#39;</span><span class="p">]</span>
<span class="n">density_plot</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;DlyReturn&#39;</span><span class="p">])</span>
<span class="n">test</span><span class="p">[</span><span class="s1">&#39;DlyReturn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">debug</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;DlyReturn&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">debug</span><span class="p">))</span></code></pre></div>
<p><img src="optimization_with_tcosts_74_0.png" alt="png" /></p>

<pre><code>1
</code></pre>

<p><img src="optimization_with_tcosts_74_2.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># distribution after winsorizing</span>
<span class="n">test</span><span class="p">[</span><span class="s1">&#39;DlyReturn_wins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wins</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;DlyReturn&#39;</span><span class="p">],</span><span class="n">wins_lower</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span><span class="n">wins_upper</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">density_plot</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;DlyReturn_wins&#39;</span><span class="p">])</span>
<span class="n">debug</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;DlyReturn_wins&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">debug</span><span class="p">))</span>
<span class="n">test</span><span class="p">[</span><span class="s1">&#39;DlyReturn_wins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span></code></pre></div>
<p><img src="optimization_with_tcosts_75_0.png" alt="png" /></p>

<pre><code>0





&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f631d640a58&gt;
</code></pre>

<p><img src="optimization_with_tcosts_75_3.png" alt="png" /></p>

<h2 id="quiz-2">Quiz</h2>

<p>Put the factor returns estimation into a function, so that this can be re-used for each day&rsquo;s data.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#: factor return is the estimated value using linear regession.</span>
<span class="c1">#: factor return multiply by the factor exposure (given) should equals to the stock daily return.</span>

<span class="k">def</span> <span class="nf">estimate_factor_returns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">wins_lower</span><span class="o">=-.</span><span class="mi">25</span><span class="p">,</span> <span class="n">wins_upper</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span> 
    <span class="c1">## TODO: build estimation universe based on filters </span>
    <span class="n">estu</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">IssuerMarketCap</span><span class="o">&gt;</span><span class="mf">1e9</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  
    <span class="c1">## TODO: winsorize returns for fitting </span>
    <span class="n">estu</span><span class="p">[</span><span class="s1">&#39;DlyReturn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wins</span><span class="p">(</span><span class="n">estu</span><span class="p">[</span><span class="s1">&#39;DlyReturn&#39;</span><span class="p">],</span><span class="n">wins_lower</span><span class="p">,</span><span class="n">wins_upper</span><span class="p">)</span>
  
    <span class="c1">## get a list of all the factors</span>
    <span class="n">all_factors</span> <span class="o">=</span> <span class="n">factors_from_names</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    
    <span class="c1">## define a &#39;formula&#39; for the regression</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="n">all_factors</span><span class="p">,</span> <span class="s2">&#34;DlyReturn&#34;</span><span class="p">)</span>
    
    <span class="c1">## create the OLS model, passing in the formula and the estimation universe dataframe</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">estu</span><span class="p">)</span>
    
    <span class="c1">## return the estimated coefficients</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></code></pre></div>
<h2 id="choose-alpha-factors">Choose alpha factors</h2>

<p>We&rsquo;ll choose the 1 day reversal, earnings yield, value, and sentiment factors as alpha factors.  We&rsquo;ll calculate the factor returns of these alpha factors to see how they performed.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">alpha_factors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;USFASTD_1DREVRSL&#34;</span><span class="p">,</span> <span class="s2">&#34;USFASTD_EARNYILD&#34;</span><span class="p">,</span> <span class="s2">&#34;USFASTD_VALUE&#34;</span><span class="p">,</span> <span class="s2">&#34;USFASTD_SENTMT&#34;</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">alpha_factors</span><span class="p">)</span></code></pre></div>
<pre><code>['USFASTD_1DREVRSL', 'USFASTD_EARNYILD', 'USFASTD_VALUE', 'USFASTD_SENTMT']
</code></pre>

<h2 id="quiz-estimate-factor-returns-of-alpha-factors">Quiz: estimate factor returns of alpha factors</h2>

<p>Loop through each day, and estimate the factors returns of each factor, that date, in the <code>frames</code> dictionary.  This may take a minute or more to run per year of data used.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">facret</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
    <span class="c1"># TODO: store factor returns as key-value pairs in a dictionary</span>
    <span class="n">facret</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimate_factor_returns</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">date</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">type</span><span class="p">(</span><span class="n">facret</span><span class="p">[</span><span class="s1">&#39;20040102&#39;</span><span class="p">])</span></code></pre></div>
<pre><code>pandas.core.series.Series
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">facret</span><span class="p">[</span><span class="s1">&#39;20040102&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<pre><code>USFASTD_1DREVRSL    0.000058
USFASTD_AERODEF    -0.006754
USFASTD_AIRLINES    0.011158
USFASTD_ALUMSTEL    0.004400
USFASTD_APPAREL    -0.018701
dtype: float64
</code></pre>

<h2 id="put-the-factor-returns-into-a-dataframe">put the factor returns into a dataframe</h2>

<p>The pandas series are stored inside a dictionary.  We&rsquo;ll put the factor returns into a dataframe where the rows are the dates and the columns are the factor returns (one column for each factor).</p>

<p>First, let&rsquo;s get a list of dates, as Timestamp objects.  We&rsquo;ll use <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.to_datetime.html">pandas.to_datetime</a></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># example of how to convert the keys of the dataframe into Timestamp objects</span>
<span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;20040102&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span></code></pre></div>
<pre><code>Timestamp('2004-01-02 00:00:00')
</code></pre>

<h2 id="quiz-3">Quiz</h2>

<p>Store the timestamp objects in a list (can use a list comprehension, or for loop).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="n">dates_unsorted</span> <span class="o">=</span> <span class="c1"># ...</span></code></pre></div>
<pre><code>  File &quot;&lt;ipython-input-58-a2c2ec027e30&gt;&quot;, line 2
    dates_unsorted = # ...
                          ^
SyntaxError: invalid syntax
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># sort the dates in ascending order</span>
<span class="n">my_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dates_unsorted</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># We&#39;ll make an empty dataframe with the dates set as the row index.</span>
<span class="n">facret_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">my_dates</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">facret_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<p>The rows are the dates.  The columns will be the factor returns.</p>

<p>To convert from Timestamp objects back into a string, we can use <a href="https://www.programiz.com/python-programming/datetime/strftime">Timestamp.strftime(&lsquo;%Y%m%d&rsquo;)</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## example usage of Timestamp.strftime(&#39;%Y%m%d&#39;)</span>
<span class="n">my_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span></code></pre></div>
<h2 id="quiz-4">Quiz</h2>

<p>For each date, and for each factor return, get the value from the dictionary and put it into the dataframe.</p>

<p>We can use <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.at.html">pandas.DataFrame.at¶</a>,</p>

<pre><code>DataFrame.at[&lt;index_value&gt;,&lt;column_name&gt;] = &lt;some_value&gt;
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: for each date (rows), and for each factor (columns),</span>
<span class="c1"># store factor return in the dataframe</span>
<span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">my_dates</span><span class="p">:</span> 
    <span class="k">for</span> <span class="n">alp</span> <span class="ow">in</span> <span class="n">alpha_factors</span><span class="p">:</span>
        <span class="n">facret_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">alp</span><span class="p">]</span> <span class="o">=</span> <span class="c1"># ...</span></code></pre></div>
<h2 id="portfolio-optimization-for-a-single-period">Portfolio optimization for a single period</h2>

<p>When we get to the project, we&rsquo;ll want to define the portfolio optimization within a function.  For now, let&rsquo;s walk through the steps we&rsquo;ll take in separate cells, so that we can see what&rsquo;s going on.</p>

<p>The optimization will want to know about the prior trading day&rsquo;s portfolio holdings, also called holdings.  The previous day&rsquo;s holdings will be used to estimate the size of the trades due to position changes, which in turn helps us estimate transaction costs.  We&rsquo;ll start with an initial holding of zero for a single stock.  The reason we&rsquo;ll use a single stock is that the estimation universe chosen on each day will include all stocks that have holdings on the previous day.  So we want to keep this list small when we first start out, else we&rsquo;ll keep many stocks that may fall below the 1 billion market cap threshold, just because they were chosen in the initialization of the backtest.</p>

<p>We&rsquo;ll want to choose a stock that is likely to satisfy the 1 billion market cap threshold on any day.  So let&rsquo;s choose the stock with the largest market cap.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># we&#39;re going to set a single barra id to have a zero portfolio holding, </span>
<span class="c1"># so let&#39;s pick any barra id of the stock with the largest issuer market cap</span>
<span class="n">estu</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;IssuerMarketCap&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[[</span><span class="s1">&#39;Barrid&#39;</span><span class="p">,</span><span class="s1">&#39;IssuerMarketCap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<h2 id="quiz-intialize-previous-holdings-dataframe">Quiz: Intialize previous holdings dataframe</h2>

<p>Create a new dataframe and initialize it with a dictionary, where the key is &ldquo;Barrid&rdquo; followed by a value that is a pandas.Series containing the barra id of the largest market cap in the stock universe.</p>

<p>Also set another key value pair to &ldquo;x.opt.previous&rdquo; and the value is set to a pandas.Series with the value 0.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="c1"># create a dataframe of previous holdings, </span>
<span class="c1"># initializing a single stock (barra id) to zero portfolio holding</span>
<span class="n">previous_holdings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Barrid&#34;</span> <span class="p">:</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span> 
                                         <span class="s2">&#34;x.opt.previous&#34;</span> <span class="p">:</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">})</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">previous_holdings</span></code></pre></div>
<p>Get a single day&rsquo;s data to be used for the portfolio optimization.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dt</span> <span class="o">=</span> <span class="n">my_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<p>Let&rsquo;s add the previous holdings column to the dataframe</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## merge previous portfolio holdings </span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">previous_holdings</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;Barrid&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<h2 id="clean-missing-and-zero-values">Clean missing and zero values.</h2>

<p>First replace missing values with zero.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">na2z</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">names_numeric_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> 
    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">clean_nas</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names_numeric_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> 
        <span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">na2z</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">clean_nas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code></pre></div>
<h2 id="quiz-clean-specific-risk">Quiz: Clean specific risk</h2>

<p>Barra calculates specific risk for each asset.  If the value in the data is zero, this may be due to missing data rather than the specific risk actually being zero.  So we&rsquo;ll set zero values to the median, to make sure our model is more realistic.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: if SpecRisk is zero, set it to median</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SpecRisk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;&#34;&#34;&lt;enter a number here&gt;&#34;&#34;&#34;</span><span class="p">][</span><span class="s1">&#39;SpecRisk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">)</span></code></pre></div>
<h2 id="universe">universe</h2>

<p>We&rsquo;ll look at stocks that are 1 billion in market cap or greater.  An important point here is that we&rsquo;ll need to account for stocks that are already in our portfolio, even if the market cap of the stock is no longer 1 billion on the current day.</p>

<h4 id="quiz-think-about-what-would-happen-if-we-had-an-existing-position-in-a-stock-then-the-market-cap-fell-below-the-threshold-and-the-stock-was-excluded-from-the-stock-universe-what-would-happen-to-the-position-on-that-stock">Quiz: think about what would happen if we had an existing position in a stock, then the market cap fell below the threshold and the stock was excluded from the stock universe.  What would happen to the position on that stock?</h4>

<h4 id="answer">Answer</h4>

<p>The stock would not be included in the optimization, which means it would be given a zero position.  So this effectively says to sell all holdings in the asset once it falls below the market cap threshold.  That&rsquo;s not what we want to do.</p>

<p>Modify the code to account for the prior day&rsquo;s positions.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## TODO: modify the given code to include the prior day&#39;s assets</span>
<span class="n">universe</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IssuerMarketCap&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1e9</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">universe</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<h2 id="quiz-nothing-here-should-be-allowed-to-look-at-returns-when-forming-the-portfolio">Quiz: Nothing here should be allowed to look at returns when forming the portfolio.</h2>

<p>Make this impossible by removing the Daily returns data from the dataframe.  Drop the DlyReturn field from the dataframe.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: drop DlyReturn column</span>
<span class="n">universe</span> <span class="o">=</span> <span class="c1"># ...</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## this will extract all of the factors, including the alphas </span>
<span class="c1"># list(universe) gets a list of the column names of the dataframe</span>
<span class="n">all_factors</span> <span class="o">=</span> <span class="n">factors_from_names</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">universe</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">all_factors</span></code></pre></div>
<h2 id="alpha-factors">Alpha factors</h2>

<p>Just a reminder that we chose four of these factors that represent previously effective alpha factors.  Since these factors became well known over time, they were added to the Barra data set.  For the time frame that we&rsquo;re running the back-test, these were effective alpha factors.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">alpha_factors</span> <span class="c1">#4 alpha factors</span></code></pre></div>
<h2 id="quiz-risk-factors">Quiz: risk factors</h2>

<p>The risk factors we&rsquo;ll use are all the factors that are not alpha factors.  Complete the setdiff function so that it takes a superset, a subset, and returns the difference as a set.</p>

<p>diff= SuperSet \ Subset</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">setdiff</span><span class="p">(</span><span class="n">superset</span><span class="p">,</span> <span class="n">subset</span><span class="p">):</span> 
    <span class="c1"># TODO: create a set from subset</span>
    <span class="n">s</span> <span class="o">=</span> <span class="c1"># ...</span>

    <span class="c1"># TODO: get the difference</span>
    <span class="n">diffset</span> <span class="o">=</span> <span class="c1"># ...</span>
    <span class="k">return</span><span class="p">(</span><span class="n">diffset</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">risk_factors</span> <span class="o">=</span> <span class="n">setdiff</span><span class="p">(</span><span class="n">all_factors</span><span class="p">,</span> <span class="n">alpha_factors</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 77 risk factors</span>
<span class="nb">len</span><span class="p">(</span><span class="n">risk_factors</span><span class="p">)</span></code></pre></div>
<p>Save initial holdings in a variable for easier access.  We&rsquo;ll later use it in matrix multiplications, so let&rsquo;s convert this to a numpy array.  We&rsquo;ll also use another variable to represent the current holdings, which are to be run through the optimizer.  We&rsquo;ll set this to be a copy of the previous holdings.  Later the optimizer will continually update this to optimize the objective function.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## initial holdings (before optimization)</span>
<span class="c1"># optimal holding from prior day</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="n">universe</span><span class="p">[</span><span class="s1">&#39;x.opt.previous&#39;</span><span class="p">]</span> <span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">h</span> <span class="o">=</span> <span class="n">h0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></code></pre></div>
<h2 id="matrix-of-risk-factor-exposures-textbf-b">Matrix of Risk Factor Exposures $\textbf{B}$</h2>

<p>The dataframe contains several columns that we&rsquo;ll use as risk factors exposures.  Extract these and put them into a matrix.</p>

<p>The data, such as industry category, are already one-hot encoded, but if this were not the case, then using <code>patsy.dmatrices</code> would help, as this function extracts categories and performs the one-hot encoding.  We&rsquo;ll practice using this package, as you may find it useful with future data sets.  You could also store the factors in a dataframe if you prefer to avoid using patsy.dmatrices.</p>

<h4 id="how-to-use-patsy-dmatrices">How to use patsy.dmatrices</h4>

<p>patsy.dmatrices takes in a formula and the dataframe.  The formula tells the function which columns to take.  The formula will look something like this:<br />
<code>SpecRisk ~ 0 + USFASTD_AERODEF + USFASTD_AIRLINES + ...</code><br />
where the variable to the left of the ~ is the &ldquo;dependent variable&rdquo; and the others to the right are the independent variables (as if we were preparing data to be fit to a model).</p>

<p>This just means that the pasty.dmatrices function will return two matrix variables, one that contains the single column for the dependent variable <code>outcome</code>, and the independent variable columns are stored in a matrix <code>predictors</code>.</p>

<p>The <code>predictors</code> matrix will contain the matrix of risk factors, which is what we want.  We don&rsquo;t actually need the <code>outcome</code> matrix; it&rsquo;s just created because that&rsquo;s the way patsy.dmatrices works.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Note that we chose &#34;SpecRisk&#34; simply because it&#39;s not one of the USFAST factors.</span>
<span class="c1"># it will be discarded in the next step.</span>
<span class="n">formula</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="n">risk_factors</span><span class="p">,</span> <span class="s2">&#34;SpecRisk&#34;</span><span class="p">)</span>
<span class="n">formula</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># the factors will be in the second returned variable (predictors)</span>
<span class="c1"># the outcome variable contains the SpecRisk data, which we don&#39;t actually need here</span>
<span class="n">outcome</span><span class="p">,</span> <span class="n">predictors</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span><span class="n">universe</span><span class="p">)</span></code></pre></div>
<p><code>predictors</code> contains the factor exposures of each asset to each factor.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">predictors</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<h2 id="factor-exposure-matrix-textbf-b">Factor exposure matrix $\textbf{B}$</h2>

<p>Remember, the factor exposure matrix has the exposure of each asset to each factor.  Thee number of rows is number of assets, and number of columns is the number of factors.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">NROW</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">NCOL</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span></code></pre></div>
<h2 id="quiz-5">Quiz</h2>

<p>Set the factor exposure matrix and its transpose, using one of the outputs from calling patsy.dmatrices</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## TODO: risk exposure matrix: </span>
<span class="n">B</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="n">BT</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

<span class="n">k</span> <span class="o">=</span> <span class="n">NCOL</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="c1">#number of factors (77)</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">NROW</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="c1">#number of assets (2000+)</span></code></pre></div>
<h2 id="factor-covariance-matrix-textbf-f">Factor covariance matrix $\textbf{F}$</h2>

<p>We can improve on the factor covariance matrix by reducing noise and also increasing computational efficiency.</p>

<p>If we have, 70 risk factors in our risk model, then the covariance matrix of factors is a 70 by 70 square matrix.  The diagonal contains the variances of each factor, while the off-diagonals contain the pairwise covariances of two different risk factors.</p>

<p>In general, it’s good to have a healthy suspicion of correlations and covariances, and to ask if correlation data adds information or just more noise.  One way to be conservative about the information in a covariance matrix is to shrink the covariances, or even reduce them to zero.  In other words, we could keep just the variances along the diagonal, and set the covariances in the off-diagonals to zero.</p>

<p>In the case where we’re using the covariance matrix in a risk factor model, there’s also some additional intuition for why we can try using just the variances, and discard the covariances.  The goal of the optimizer is to reduce the portfolio’s exposure to these risk factors.  So if the optimizer reduces the portfolio’s exposure to risk factor “one”, and also reduces its exposure to risk factor “two”, then it’s less important to know exactly how factor one varies with factor two.</p>

<p>You may wonder what are the benefits of throwing away the information about the covariances.  In addition to making your model more conservative, and limiting possible noise in your data, a diagonal matrix also makes matrix operations more efficient.  This theme of computational efficiency is one that you’ll come across in many use cases, including backtesting.  Backtesting is a computationally and time-intensive process, so the more efficient you can make it, the more quickly you can test your alphas, and iterate to make improvements.</p>

<h2 id="create-factor-covariance-matrix-textbf-f">Create Factor covariance matrix $\textbf{F}$</h2>

<p>You can try getting all covariances into the matrix.  Notice that we&rsquo;ll run into some issues where the covariance data doesn&rsquo;t exist.</p>

<p>One important point to remember is that we need to order the factors in the covariance matrix F so that they match up with the order of the factors in the factor exposures matrix B.</p>

<p>Note that covariance data is in percentage units squared, so to use decimals, so we&rsquo;ll rescale it to convert it to decimal.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## With all covariances</span>
<span class="k">def</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="n">patsy</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">DesignMatrix</span><span class="p">):</span> 
        <span class="k">return</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> 
        <span class="k">return</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">return</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<span class="c1">## extract a diagonal element from the factor covariance matrix </span>
<span class="k">def</span> <span class="nf">get_cov_version1</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">factor1</span><span class="p">,</span> <span class="n">factor2</span><span class="p">):</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">cv</span><span class="o">.</span><span class="n">Factor1</span><span class="o">==</span><span class="n">factor1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">Factor2</span><span class="o">==</span><span class="n">factor2</span><span class="p">),</span><span class="s2">&#34;VarCovar&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;didn&#39;t find covariance for: factor 1: {factor1} factor2: {factor2}&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">diagonal_factor_cov_version1</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    Notice that we&#39;ll use the order of column names of the factor exposure matrix
</span><span class="s2">    to set the order of factors in the factor covariance matrix
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">NCOL</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">Fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">):</span> 
            <span class="n">fac1</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">(</span><span class="n">B</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fac2</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">(</span><span class="n">B</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># Convert from percentage units squared to decimal</span>
            <span class="n">Fm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.01</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">get_cov_version1</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">fac1</span><span class="p">,</span> <span class="n">fac2</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">Fm</span><span class="p">)</span></code></pre></div>
<p>Here&rsquo;s an example where the two factors don&rsquo;t have covariance data for the date selected</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">cv</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[</span><span class="s1">&#39;20031211&#39;</span><span class="p">]</span>
<span class="n">cv</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">cv</span><span class="o">.</span><span class="n">Factor1</span><span class="o">==</span><span class="s1">&#39;USFASTD_AERODEF&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">Factor2</span><span class="o">==</span><span class="s1">&#39;USFASTD_ALUMSTEL&#39;</span><span class="p">)]</span></code></pre></div>
<p>We can see where all the factor covariances aren&rsquo;t found in the data.</p>

<h2 id="which-date">Which date?</h2>

<p>Recall that there&rsquo;s a DataDate column and DlyReturnDate column in the dataframe.  We&rsquo;re going to use a date to access the covariance data.  Which date should we use?</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<h2 id="answer-here">Answer here</h2>

<h2 id="quiz-6">Quiz</h2>

<p>Choose the correct date, then use the <code>diagonal_factor_cov_version1</code> to get the factor covariance matrix of that date.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">universe</span><span class="p">[</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
<span class="n">F_version1</span> <span class="o">=</span> <span class="n">diagonal_factor_cov_version1</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span></code></pre></div>
<h2 id="quiz-create-matrix-of-factor-variances">Quiz: Create matrix of factor variances</h2>

<p>Just use the factor variances and set the off diagonal covariances to zero.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="n">patsy</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">DesignMatrix</span><span class="p">):</span> 
        <span class="k">return</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> 
        <span class="k">return</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">return</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<span class="c1">## extract a diagonal element from the factor covariance matrix </span>
<span class="k">def</span> <span class="nf">get_var</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span> 
    <span class="c1"># TODO</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">cv</span><span class="o">.</span><span class="n">Factor1</span><span class="o">==</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="o">==</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">),</span><span class="s2">&#34;VarCovar&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">diagonal_factor_cov</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    Notice that we&#39;ll use the order of column names of the factor exposure matrix
</span><span class="s2">    to set the order of factors in the factor covariance matrix
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="c1"># TODO: set the variances only</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">NCOL</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">Fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">):</span> 
        <span class="n">fac</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">(</span><span class="n">B</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">Fm</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="c1"># ...</span>
    <span class="k">return</span><span class="p">(</span><span class="n">Fm</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## factor variances </span>
<span class="c1"># gets factor vars into diagonal matrix</span>
<span class="c1"># takes B to know column names of B; F will be multipled by B later</span>
<span class="c1"># F is square; so row and col names must match column names of B.</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">diagonal_factor_cov</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">F</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<p>Note how the off diagonals are all set to zero.</p>

<h2 id="alpha-combination">alpha combination</h2>

<p>As a simple alpha combination, combine the alphas with equal weight.  In the project, you&rsquo;re welcome to try other ways to combine the alphas.  For example, you could calculate some metric for each factor, which indicates which factor should be given more or less weight.</p>

<h2 id="scale-factor-exposures">Scale factor exposures</h2>

<p>Note that the terms that we&rsquo;re calculating for the objective function will be in dollar units.  So the expected return $-\alpha^T h$ will be in dollar units.  The $h$ vector of portfolio holdings will be in dollar units.  The vector of alpha factor exposures $\alpha$ will represent the percent change expected for each stock.  Based on the ranges of values in the factor exposure data, which are mostly between -5 and +5 and centered at zero, <strong>we&rsquo;ll make an assumption that a factor exposure of 1 maps to 1 basis point of daily return on that stock.</strong></p>

<p>So we&rsquo;ll convert the factor values into decimals: 1 factor exposure value $\rightarrow \frac{1}{10,000}$ in daily returns.  In other words, we&rsquo;ll rescale the alpha factors by dividing by 10,000.</p>

<p>This is to make the term representing the portfolio&rsquo;s expected return $\alpha^T h$ be scaled so that it represents dollar units.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">alpha_factors</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">model_matrix</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> 
    <span class="n">outcome</span><span class="p">,</span> <span class="n">predictors</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">predictors</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## matrix of alpha factors</span>
<span class="n">B_alpha</span> <span class="o">=</span> <span class="n">model_matrix</span><span class="p">(</span><span class="n">get_formula</span><span class="p">(</span><span class="n">alpha_factors</span><span class="p">,</span> <span class="s2">&#34;SpecRisk&#34;</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">universe</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">B_alpha</span></code></pre></div>
<h2 id="quiz-7">Quiz</h2>

<p>Sum across the rows, then re-scale so that the expression $\mathbf{\alpha}^T \mathbf{h}$ is in dollar units.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">rowSums</span><span class="p">(</span><span class="n">m</span><span class="p">):</span> 
    <span class="c1"># TODO</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="n">scale</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="n">alpha_vec</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">rowSums</span><span class="p">(</span><span class="n">B_alpha</span><span class="p">)</span> <span class="c1">#sum across rows (collapse 4 columns into one)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">alpha_vec</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<h2 id="original-method-of-calculating-common-risk-term">Original method of calculating common risk term</h2>

<p>Recall that the common risk term looks like this:
$\textbf{h}^T\textbf{BFB}^T\textbf{h}$</p>

<p>Where h is the vector of portfolio holdings, B is the factor exposure matrix, and F is the factor covariance matrix.</p>

<p>We&rsquo;ll walk through this calculation to show how it forms an N by N matrix, which is computationally expensive, and may lead to memory overflow for large values of N.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">h</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">F</span><span class="p">),</span><span class="n">BT</span><span class="p">)</span> <span class="p">),</span> <span class="n">h</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">F</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">shape</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># this makes an N by matrix (large)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">BT</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">shape</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">shape</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">shape</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span></code></pre></div>
<h2 id="efficiently-calculate-common-risk-term-avoid-n-by-n-matrix">Efficiently calculate common risk term (avoid N by N matrix)</h2>

<p>Calculate the portfolio risk that is attributable to the risk factors:
$\mathbf{h}^T\mathbf{BFB}^T\mathbf{h}$</p>

<p>Note that this can become computationally infeasible and/or slow.  Use matrix factorization and carefully choose the order of matrix multiplications to avoid creating an N by N matrix.</p>

<h4 id="square-root-of-a-matrix">square root of a matrix.</h4>

<p>We can find a matrix $\mathbf{B}$ that&rsquo;s the matrix square root of another matrix $\mathbf{A}$, which means that if we matrix multiply $\mathbf{BB}$, we&rsquo;d get back to the original matrix $\mathbf{A}$.</p>

<p>Find $\mathbf{Q}$ such that $\mathbf{Q}^T\mathbf{Q}$ is the same as $\mathbf{BFB}^T$.  Let&rsquo;s let $\mathbf{G}$ denote the square root of matrix $\mathbf{F}$, so that $\mathbf{GG} = \mathbf{F}$.</p>

<p>Then the expression for the covariance matrix of assets, $\mathbf{BFB}^T$, can be written as $\mathbf{BGGB}^T$.</p>

<p>Let&rsquo;s let $\mathbf{Q}=\mathbf{GB}^T$ and let $\mathbf{Q}^T=\mathbf{BG}$, which means we can rewrite $\mathbf{BGGB}^T = \mathbf{Q}^T\mathbf{Q}$, and the common risk term is $\mathbf{h}^T\mathbf{Q}^T\mathbf{Qh}$</p>

<p>Also, note that we don&rsquo;t have to calculate $\mathbf{BFB}^T$ explicitly, because the actual value we wish to calculate in the objective function will apply the holdings $\mathbf{h}$ to the covariance matrix of assets.</p>

<h2 id="quiz-matrix-square-root-of-f">Quiz: matrix square root of F</h2>

<p>We&rsquo;ll call this square root matrix $\mathbf{G}$</p>

<p>Use <a href="https://docs.scipy.org/doc/scipy-0.15.1/reference/generated/scipy.linalg.sqrtm.html">scipy.linalg.sqrtm</a></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="n">G</span> <span class="o">=</span> <span class="c1"># ...</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">G</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<p>Double check that multiplying the square root matrix to itself returns us back to the original matrix of factor variances.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">G</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span></code></pre></div>
<h2 id="quiz-calculate-textbf-q-and-textbf-q-t">Quiz: calculate $\textbf{Q}$ and $\textbf{Q}^T$</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="c1"># Q = GB&#39;</span>
<span class="c1"># Q should be a short and wide matrix</span>
<span class="n">Q</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="n">Q</span><span class="o">.</span><span class="n">shape</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="c1"># Q&#39; = BG</span>
<span class="c1"># Q should be a tall and narrow matrix</span>
<span class="n">QT</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="n">QT</span><span class="o">.</span><span class="n">shape</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># notice we could also use the transpose of Q to get Q&#39;</span>
<span class="n">QT</span> <span class="o">-</span> <span class="n">Q</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span></code></pre></div>
<h2 id="quiz-include-portfolio-holdings">Quiz: Include portfolio holdings</h2>

<p>So the original formula of
$h^TBFB^Th$ became<br />
$h^TBGGB^Th$, where $GG = F$.</p>

<p>And then, if we let $Q^T=BG$ and $Q = GB^T$:<br />
$h^TQ^TQh$</p>

<p>Let $R = Q h$ and $R^T = h^T Q^T$:</p>

<p>The risk term becomes:<br />
$R^TR$, where $R^T=h^TQ$ and $R=Q^Th$</p>

<p>So an important point here is that we don&rsquo;t want to multiply $Q^TQ$ itself, because this creates the large N by N matrix. We want to multiply $h^TQ^T$ and $Qh$ separately, creating vectors of length k (k is number of risk factors).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="c1"># R = Qh</span>
<span class="n">R</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="n">R</span><span class="o">.</span><span class="n">shape</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="c1"># R&#39; = Q&#39;h&#39;</span>
<span class="n">RT</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="n">RT</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<h2 id="notice-how-we-avoided-creating-a-full-n-by-n-matrix">Notice how we avoided creating a full N by N matrix</h2>

<p>Also, notice that if we have Q, we can take its transpose to get $Q^T$ instead of doing the matrix multiplication.</p>

<p>Similarly, if we have R, which is a vector, we notice that $R^TR$ is the same as taking the dot product.  In other words, it&rsquo;s squaring each element in the vector R, and adding up all the squared values.</p>

<p>$R^TR = \sum_{i}^{k}(r_i^2)$</p>

<h2 id="quiz-put-it-all-together-calculate-common-risk-term-efficiently">Quiz: Put it all together: calculate common risk term efficiently</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## TODO: common risk term in term</span>

<span class="c1"># TODO: calculate square root of F</span>
<span class="n">G</span> <span class="o">=</span> <span class="c1"># ...</span>

<span class="c1"># TODO: calculate Q</span>
<span class="n">Q</span> <span class="o">=</span> <span class="c1"># ...</span>

<span class="c1"># TODO: calculate R</span>
<span class="n">R</span> <span class="o">=</span> <span class="c1"># ...</span>

<span class="c1"># TODO: calculate common risk term</span>
<span class="n">common_risk</span> <span class="o">=</span> <span class="c1"># ...</span></code></pre></div>
<h2 id="specific-risk-term">Specific Risk term</h2>

<p>The portfolio&rsquo;s variance that is specific to each asset is found by combining the holdings with the specific variance matrix:</p>

<p>$h^TSh$, where $h^T$ is a 1 by N vector, S is an N by N matrix, and h is an N by 1 vector.</p>

<p>Recall that S is a diagonal matrix, so all the off-diagonals are zero.  So instead of doing the matrix multiplication, we could save computation by working with the vector containing the diagonal values.</p>

<p>$h^TSh = \sum_i^{N}(h_i^2 \times S_i)$ because $S$ is a diagonal matrix.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## check the unit of measure of SpecRisk</span>
<span class="c1"># Notice that these are in percent; multiply by .01 to get them back to decimals.aa</span>
<span class="n">universe</span><span class="p">[</span><span class="s1">&#39;SpecRisk&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> </code></pre></div>
<h2 id="quiz-specific-risk-term">Quiz: Specific Risk term</h2>

<p>Given specific risk (volatility), calculate specific variance.  First re-scale the specific risk data so that it&rsquo;s in decimal instead of percent.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## TODO: specific variance : rescale it and then square to get specific variance</span>
<span class="n">specVar</span> <span class="o">=</span> <span class="c1"># ...</span>

<span class="c1"># TODO: specific risk term (include holdings)</span>
<span class="n">spec_risk_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">)</span></code></pre></div>
<h2 id="maximize-portfolio-returns">Maximize portfolio returns</h2>

<p>Since the alpha vector $\mathbf{\alpha}$ is supposed to be indicative of future asset returns, when we look at a portfolio of assets, the weighted sum of these alphas $\mathbf{\alpha}^T \mathbf{h}$ is predictive of the portfolio&rsquo;s future returns.  We want to maximize the portfolio&rsquo;s expected future returns, so we want to minimize the negative of portfolio&rsquo;s expected returns $-\mathbf{\alpha}^T \mathbf{h}$</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## TODO</span>
<span class="n">expected_return</span> <span class="o">=</span> <span class="c1"># ...</span></code></pre></div>
<h2 id="linear-price-impact-of-trading">Linear price impact of trading</h2>

<p>Assume transaction cost is linearly related to the trade size as a fraction of the average daily volume.  Since we won&rsquo;t know the actual daily volume until the day that we&rsquo;re executing, we want to use past data as an estimate for future daily volume.  This would be kind of noisy if we simply use the prior day&rsquo;s daily volume, so we&rsquo;d prefer a more stable estimate like a 30 day rolling average.</p>

<p>A commonly used <strong>estimate for linear market impact is that if a trade size is 1% of the ADV, this moves the price by 10 basis points (<sup>1</sup>&frasl;<sub>10</sub>,000).</strong></p>

<p>$Trade size_{i,t}$ is the fraction of your trade relative to the average dollar volume estimated for that stock, for that day.</p>

<p>$Trade<em>{i,t}$ = dollar amount to trade = $h</em>{t} - h_{t-1}$, which is the new holding of the asset minus the previous holding.</p>

<p>$ADV_{i,t}$: (average dollar volume) is total dollar amount expected to be traded, based on a moving average of historical daily volume.</p>

<p>$TradeSize<em>{i,t} = \frac{Trade</em>{i,t}}{ADV_{i,t}}$: The size of the trade relative to the estimated daily volume.</p>

<p>$\% \Delta Price_{i,t}$ = price change due to trading, as a fraction of the original price (it&rsquo;s a percent change).</p>

<p>We&rsquo;ll write out the ratio: change in price divided by the trade size.</p>

<p>$ \frac{\% \Delta price<em>{i,t}}{TradeSize</em>{i,t}} = \frac{10 bps}{1\%}$</p>

<p>$ \frac{\% \Delta price<em>{i,t}}{TradeSize</em>{i,t}} = \frac{<sup>10</sup>&frasl;<sub>10</sub>^4}{<sup>1</sup>&frasl;<sub>100</sub>}$</p>

<p>$ \frac{\% \Delta price<em>{i,t}}{TradeSize</em>{i,t}} = \frac{10^{-3}}{10^{-2}}$</p>

<p>$ \frac{\% \Delta price<em>{i,t}}{TradeSize</em>{i,t}} = 10^{-1}$</p>

<p>Now we&rsquo;ll move things around to solve for the change in price.</p>

<p>$\%  \Delta price<em>{i,t} = 10^{-1} \times TradeSize</em>{i,t}$</p>

<p>We defined TradeSize to be the Trade divided by ADV.</p>

<p>$\%  \Delta price<em>{i,t} = 10^{-1} \times \frac{Trade</em>{i,t}}{ADV_{i,t}}$</p>

<p>Note that Trade is the current position minus the prior day&rsquo;s position</p>

<p>$\%  \Delta price<em>{i,t} = 10^{-1} \times \frac{h</em>{i,t} - h<em>{i,t-1}}{ADV</em>{i,t}}$</p>

<p>For convenience, we&rsquo;ll combine the constant $10^{-1}$ and $\frac{1}{ADV<em>{i}}$ and call it lambda $\lambda</em>{i}$</p>

<p>$\%  \Delta price<em>{i,t} = \lambda</em>{i,t} \times (h<em>{i,t} - h</em>{i,t-1})$ where $\lambda<em>{i,t} = 10^{-1}\times \frac{1}{ADV</em>{i,t}} = \frac{1}{10 \times ADV_{i,t}}$</p>

<p>Note that since we&rsquo;re dividing by $ADV<em>{i,t}$, we&rsquo;ll want to handle cases when $ADV</em>{i,t}$ is missing or zero.  In those instances, we can set $ADV_{i,t}$ to a small positive number, such as 10,000, which, in practice assumes that the stock is illiquid.</p>

<p>Represent the market impact as $\Delta price<em>{i} = \lambda</em>{i} (h<em>{i,t} - h</em>{i,t-1})$.  $\lambda<em>{i}$ incorporates the $ADV</em>{i,t}$.  Review the lessons to see how to do this.</p>

<p>Note that since we&rsquo;re dividing by $ADV<em>{i,t}$, we&rsquo;ll want to handle cases when $ADV</em>{i,t}$ is missing or zero.  In those instances, we can set $ADV_{i,t}$ to a small positive number, such as 10,000, which, in practice assumes that the stock is illiquid.</p>

<h2 id="quiz-8">Quiz</h2>

<p>If the ADV field is missing or zero, set it to 10,000.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: if missing, set to 10000</span>
<span class="n">universe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">universe</span><span class="p">[</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">]),</span> <span class="s1">&#39;ADTCA_30&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span> <span class="c1">## assume illiquid if no volume information</span>

<span class="c1"># TODO: if zero, set to 10000</span>
<span class="n">universe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">universe</span><span class="p">[</span><span class="s1">&#39;ADTCA_30&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span> <span class="s1">&#39;ADTCA_30&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span> <span class="c1">## assume illiquid if no volume information</span></code></pre></div>
<h2 id="quiz-calculate-lambda">Quiz: calculate Lambda</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="n">adv</span> <span class="o">=</span> <span class="c1"># ...</span>
<span class="n">Lambda</span> <span class="o">=</span> <span class="c1"># ...</span></code></pre></div>
<h2 id="quiz-transaction-cost-term">Quiz: transaction cost term</h2>

<p>Transaction cost is change in price times dollar amount traded.  For a single asset &ldquo;i&rdquo;:</p>

<p>$tcost<em>{i,t} = (\% \Delta price</em>{i,t}) \times (DollarsTraded_{i,t})$</p>

<p>$tcost<em>{i,t} = (\lambda</em>{i,t} \times (h<em>{i,t} - h</em>{i,t-1}) ) \times (h<em>{i,t} - h</em>{i,t-1})$</p>

<p>Notice that we can simplify the notation so it looks like this:</p>

<p>$tcost<em>{i,t} = \lambda</em>{i,t} \times (h<em>{i,t} - h</em>{i,t-1})^2$</p>

<p>The transaction cost term to be minimized (for all assets) is:</p>

<p>$tcost_{t} = \sum<em>i^{N} \lambda</em>{i,t} (h<em>{i,t} - h</em>{i,t-1})^2$<br />
where $\lambda<em>{i,t} = \frac{1}{10\times ADV</em>{i,t}}$</p>

<p>For matrix notation, we&rsquo;ll use a capital Lambda, $\Lambda<em>{t}$, instead of the lowercase lambda $\lambda</em>{i,t}$.</p>

<p>$tcost<em>{t} = (\mathbf{h}</em>{t} - \mathbf{h}_{t-1})^T \mathbf{\Lambda}<em>t (\mathbf{h}</em>{t} - \mathbf{h}_{t-1})$</p>

<p>Note that we&rsquo;ll pass in a vector of holdings as a numpy array.  For practice, we&rsquo;ll use the h variable that is initialized to zero.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="n">tcost</span> <span class="o">=</span> <span class="c1"># ...</span></code></pre></div>
<h2 id="objective-function">objective function</h2>

<p>Combine the common risk, idiosyncratic risk, transaction costs and expected portfolio return into the objective function.  Put this inside a function.</p>

<p>Objective function is:<br />
factor risk + idiosyncratic risk - expected portfolio return + transaction costs<br />
$f(\mathbf{h}) = \frac{1}{2}\kappa \mathbf{h}_t^T\mathbf{Q}^T\mathbf{Q}\mathbf{h}_t + \frac{1}{2} \kappa \mathbf{h}_t^T \mathbf{S} \mathbf{h}_t - \mathbf{\alpha}^T \mathbf{h}<em>t + (\mathbf{h}</em>{t} - \mathbf{h}<em>{t-1})^T \mathbf{\Lambda} (\mathbf{h}</em>{t} - \mathbf{h}_{t-1})$</p>

<h2 id="risk-aversion-kappa">Risk Aversion $\kappa$</h2>

<p>The risk aversion term is set to target a particular gross market value (GMV), or to target a desired volatility.  In our case, we tried a few values of the risk aversion term, ran the backtest, and calculated the GMV.  Ideally, a quant who is just starting out may have a targeted GMV of 50 million.  A risk aversion term of $10^{-6}$ gets the GMV to be in the tens of millions.  A higher risk aversion term would decrease the GMV, and a lower risk aversion term would increase the GMV, and also the risk.  Note that this isn&rsquo;t necessarily a linear mapping, so in practice, you&rsquo;ll try different values and check the results.</p>

<p>Also, in practice, you&rsquo;d normally keep the risk aversion term constant, unless your fund is accepting more investor cash, or handling redemptions.  In those instances, the fund size itself changes, so the targeted GMV also changes.  Therefore, we&rsquo;d adjust the risk aversion term to adjust for the desired GMV.</p>

<p>Also, note that we would keep this risk aversion term constant, and not adjust it on a daily basis.  Adjusting the risk aversion term too often would result in unecessary trading that isn&rsquo;t informed by the alphas.</p>

<h2 id="quiz-9">Quiz</h2>

<p>An important point is to think about what matrices can be multiplied independently of the vector of asset holdings, because those can be done once outside of the objective function.  The rest of the objective function that depends on the holdings vector will be evaluated inside the objective function multiple times by the optimizer, as it searches for the optimal holdings.</p>

<p>For instance,</p>

<p>$\mathbf{h}^T\mathbf{BFB}^T\mathbf{h}$ became<br />
$\mathbf{h}^T\mathbf{BGGB}^T\mathbf{h}$, where $\mathbf{GG} = \mathbf{F}$.</p>

<p>And then, if we let $\mathbf{Q}^T=\mathbf{BG}$ and $\mathbf{Q} = \mathbf{GB}^T$:<br />
$\mathbf{h}^T\mathbf{Q}^T\mathbf{Qh}$</p>

<p>Let $\mathbf{R} = \mathbf{Q h}$ and $\mathbf{R}^T = \mathbf{h}^T \mathbf{Q}^T$:</p>

<p>The risk term becomes:<br />
$\mathbf{R}^T\mathbf{R}$, where $\mathbf{R}^T=\mathbf{h}^T\mathbf{Q}$ and $\mathbf{R}=\mathbf{Q}^T\mathbf{h}$</p>

<ul>
<li>Can we pre-compute Q outside of the objective function?<br /></li>
<li>Can we pre-compute R outside of the objective function?</li>
</ul>

<h4 id="answer-1">Answer</h4>

<p>Q doesn&rsquo;t depend on h, the holdings vector, so it can be pre-computed once outside of the objective function.</p>

<p>R is created using h, the holdings vector.  This should be computed each time the objective function is called, not pre-computed beforehand.</p>

<h2 id="risk-aversion-parameter">Risk Aversion parameter</h2>

<p>The risk aversion term is set to target a particular gross market value (GMV), or to target a desired volatility.</p>

<p>The gross market value is the dollar value of the absolute value of the long and short positions.</p>

<p>$ GMV = \sum<em>i^N(|h</em>{i,t}|)$</p>

<p>When we think about what it means to take more risk when investing, taking bigger bets with more money is a way to take on more risk.  So the risk aversion term controls how much risk we take by controlling the dollar amount of our positions, which is the gross market value.</p>

<p>In our case, we tried a few values of the risk aversion term, ran the backtest, and calculated the GMV.  Ideally, a quant who is just starting out may have a targeted book size of 50 million.  In other words, they try to keep their GMV around 50 million.</p>

<p>A risk aversion term of $10^{-6}$ gets the GMV to be in the tens of millions.  A higher risk aversion term would decrease the GMV, and a lower risk aversion term would increase the GMV, and also the risk.  Note that this isn&rsquo;t necessarily a linear mapping, so in practice, you&rsquo;ll try different values and check the results.</p>

<p>Also, in practice, you&rsquo;d normally keep the risk aversion term constant, unless your fund is accepting more investor cash, or handling redemptions.  In those instances, the fund size itself changes, so the targeted GMV also changes.  Therefore, we&rsquo;d adjust the risk aversion term to adjust for the desired GMV.</p>

<p>Also, note that we would keep this risk aversion term constant, and not adjust it on a daily basis.  Adjusting the risk aversion term too often would result in unnecessary trading that isn&rsquo;t informed by the alphas.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">## Risk aversion</span>
<span class="n">risk_aversion</span><span class="o">=</span><span class="mf">1.0e-6</span></code></pre></div>
<h2 id="quiz-define-objective-function">Quiz: define objective function</h2>

<p>Combine the common risk, idiosyncratic risk, transaction costs and expected portfolio return into the objective function.  Put this inside a function.</p>

<p>Objective function is:<br />
factor risk + idiosyncratic risk - expected portfolio return + transaction costs<br />
$f(\mathbf{h}) = \frac{1}{2}\kappa \mathbf{h}_t^T\mathbf{Q}^T\mathbf{Q}\mathbf{h}_t + \frac{1}{2} \kappa \mathbf{h}_t^T \mathbf{S} \mathbf{h}_t - \mathbf{\alpha}^T \mathbf{h}<em>t + (\mathbf{h}</em>{t} - \mathbf{h}<em>{t-1})^T \mathbf{\Lambda} (\mathbf{h}</em>{t} - \mathbf{h}_{t-1})$</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">h</span><span class="p">):</span> 
    <span class="c1"># TODO: define the objective function, where h is the vector of asset holdings</span>
    <span class="n">f</span> <span class="o">=</span> <span class="c1"># ...</span>
    <span class="k">return</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></code></pre></div>
<h2 id="gradient">Gradient</h2>

<p>Before, when we used cvxpy, we didn&rsquo;t have to calculate the gradient, because the library did that for us.</p>

<p>Objective function is:<br />
factor risk + idiosyncratic risk - expected portfolio return + transaction costs<br />
$f(\mathbf{h}) = \frac{1}{2}\kappa \mathbf{h}^T\mathbf{Q}^T\mathbf{Qh} + \frac{1}{2} \kappa \mathbf{h}^T \mathbf{S h} - \mathbf{\alpha^T h} + (\mathbf{h}<em>{t} - \mathbf{h}</em>{t-1})^T \Lambda (\mathbf{h}<em>{t} - \mathbf{h}</em>{t-1})$</p>

<p>Let&rsquo;s think about the shape of the resulting gradient. The reason we&rsquo;re interested in calculating the derivative is so that we can tell the optimizer in which direction, and how much, it should shift the portfolio holdings in order to improve the objective function (minimize variance, minimize transaction cost, and maximize expected portfolio return).  So we want to calculate a derivative for each of the N assets (about 2000+ in our defined universe).  So the resulting gradient will be a row vector of length N.</p>

<p>The gradient, or derivative of the objective function, with respect to the portfolio holdings h, is:</p>

<p>$f&rsquo;(\mathbf{h}) = \frac{1}{2}\kappa (2\mathbf{Q}^T\mathbf{Qh}) + \frac{1}{2}\kappa (2\mathbf{Sh}) - \mathbf{\alpha} + 2(\mathbf{h}<em>{t} - \mathbf{h}</em>{t-1}) \mathbf{\Lambda}$</p>

<p>We can check that each of these terms is a row vector with one value for each asset (1 by N row vector)</p>

<h2 id="quiz-10">Quiz</h2>

<p>Calculate the gradient of the common risk term:</p>

<p>$\kappa (\mathbf{Q}^T\mathbf{Qh})$</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: gradient of common risk term</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">))</span></code></pre></div>
<p>Verify that the calculation returns one value for each asset in the stock universe (about 2000+ )</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<h2 id="quiz-11">Quiz</h2>

<p>Calculate gradient of idiosyncratic risk term</p>

<p>$\kappa (\mathbf{Sh})$</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: idiosyncratic risk gradient</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span> <span class="o">*</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span> <span class="o">*</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<h2 id="quiz-12">Quiz</h2>

<p>Calculate the gradient of the expected return</p>

<p>$- \mathbf{\alpha} $</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: expected return gradient</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<h2 id="quiz-13">Quiz</h2>

<p>Calculate the gradient of the transaction cost.</p>

<p>$ 2(\mathbf{h}<em>{t} - \mathbf{h}</em>{t-1}) \mathbf{\Lambda}$</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># transaction cost</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span> <span class="o">*</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span></code></pre></div>
<h2 id="quiz-define-gradient-function">Quiz: Define gradient function</h2>

<p>Put this all together to define the gradient function.  The optimizer will use this to make small adjustments to the portfolio holdings.</p>

<h4 id="gradient-slightly-cleaned-up">gradient (slightly cleaned up)</h4>

<p>We&rsquo;ll simplify the expression a bit by pulling the common $\kappa$ out of the common risk and specific risk.  Also, the <sup>1</sup>&frasl;<sub>2</sub> and 2 cancel for both risk terms.</p>

<p>$f&rsquo;(\mathbf{h}) = \frac{1}{2}\kappa (2\mathbf{Q}^T\mathbf{Qh}) + \frac{1}{2}\kappa (2\mathbf{h}^T\mathbf{S}) - \mathbf{\alpha} + 2(\mathbf{h}<em>{t} - \mathbf{h}</em>{t-1})\cdot \Lambda$</p>

<p>becomes</p>

<p>$f&rsquo;(\mathbf{h}) = \kappa (\mathbf{Q}^T\mathbf{Qh} + \mathbf{Sh}) - \mathbf{\alpha} + 2(\mathbf{h}<em>{t} - \mathbf{h}</em>{t-1}) \mathbf{\Lambda}$</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Solution</span>
<span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># TODO</span>
    <span class="n">g</span> <span class="o">=</span> <span class="c1"># ...</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">g</span><span class="p">))</span></code></pre></div>
<h2 id="optimizer">Optimizer</h2>

<p>Choose an optimizer.  You can read about these optimizers:</p>

<ul>
<li>L-BFGS<br /></li>
<li>Powell</li>
<li>Nelder-Mead</li>
<li>Conjugate Gradient</li>
</ul>

<p>In this <a href="http://scipy-lectures.org/advanced/mathematical_optimization/">page about math optimization</a></p>

<p>Also read the <a href="https://docs.scipy.org/doc/scipy/reference/optimize.html">scipy.optimize documentation</a></p>

<p>Pass in the objective function, prior day&rsquo;s portfolio holdings, and the gradient.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO</span>
<span class="n">optimizer_result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fmin_l_bfgs_b</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span> <span class="n">fprime</span><span class="o">=</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">)</span>

<span class="n">h1</span> <span class="o">=</span> <span class="n">optimizer_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">opt_portfolio</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Barrid&#34;</span> <span class="p">:</span> <span class="n">universe</span><span class="p">[</span><span class="s1">&#39;Barrid&#39;</span><span class="p">],</span> <span class="s2">&#34;h.opt&#34;</span> <span class="p">:</span> <span class="n">h1</span><span class="p">})</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">opt_portfolio</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<h2 id="risk-exposures">risk exposures</h2>

<p>factor exposures times the portfolio holdings for each asset, gives the portfolio&rsquo;s exposure to the factors (portfolio&rsquo;s risk exposure).</p>

<p>$\mathbf{B}^T\mathbf{h}$</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># TODO: risk exposures</span>
<span class="n">risk_exposures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">)</span>

<span class="c1"># put this into a pandas series</span>
<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">risk_exposures</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">(</span><span class="n">B</span><span class="p">))</span></code></pre></div>
<h2 id="quiz-alpha-exposures">Quiz: alpha exposures</h2>

<p>The portfolio&rsquo;s exposures to the alpha factors is equal to the matrix of alpha exposures times the portfolio holdings.  We&rsquo;ll use the holdings returned by the optimizer.</p>

<p>$\textbf{B}_{\alpha}^T\mathbf{h}$</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Solution: portfolio&#39;s alpha exposure</span>
<span class="n">alpha_exposures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;&#34;&lt;your code here&gt;&#34;&#34;&#34;</span><span class="p">)</span>

<span class="c1"># put into a pandas series</span>
<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">alpha_exposures</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">(</span><span class="n">B_alpha</span><span class="p">))</span></code></pre></div>
<h2 id="hints-for-the-project">Hints for the project</h2>

<p>You&rsquo;ll be putting this optimization code into functions so that you can call the optimizer in a loop, as the backtester walks through each day in the data.</p>

<h2 id="solution-notebook">Solution notebook</h2>

<p>The solution notebook is <a href="optimization_with_tcosts_solution.ipynb">here</a></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"></code></pre></div>
    </div>
  </div>
</article>


            </div>

        </div>
    </div>

    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">This project contains 5 pages and is available on <a href="https://github.com/">GitHub</a>. Copyright &copy; , <time datetime="2019">2019</time>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>